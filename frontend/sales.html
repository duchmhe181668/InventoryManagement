<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sales</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <link rel="stylesheet" href="css/sales.css"/>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand text-white fw-bold me-4" href="home.html">
          <i class="fas fa-home me-1"></i> Trang chủ
        </a>

        <div class="d-flex align-items-center flex-grow-1 mx-3 gap-2 flex-wrap">
          <div class="input-group search-box">
            <span class="input-group-text bg-white border-0" id="search-addon">
              <i class="fas fa-search text-muted"></i>
            </span>
            <input
              type="text"
              class="form-control border-0"
              placeholder="Tìm hàng hóa"
              id="product-search-input"
              aria-label="Search"
              aria-describedby="search-addon"/>
          </div>

          <ul class="nav nav-pills align-items-center flex-wrap gap-1" id="invoice-tabs"></ul>

          <button class="btn btn-outline-light btn-sm" id="btn-add-invoice" type="button" title="Thêm hóa đơn (Ctrl+N)">
            <i class="fas fa-plus me-1"></i> Hóa đơn
          </button>
        </div>

        <div class="d-flex align-items-center">
          <div class="dropdown">
            <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-bars"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="#">Tài khoản</a></li>
              <li><a class="dropdown-item" href="#" id="btn-logout">Đăng xuất</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <div class="main-content row g-0">
      <div class="left-panel col-md-8">
        <div class="search-customer mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-user"></i></span>
            <input type="text" class="form-control" placeholder="Tìm khách hàng"/>
            <button class="btn btn-outline-primary" title="Thêm khách hàng">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>

        <div id="search-results" class="search-results-dropdown d-none"></div>

        <div id="cart-items-container">
          <p id="empty-cart-message" class="text-center text-muted mt-5">Chưa có sản phẩm nào trong giỏ hàng.</p>
        </div>
      </div>

      <div class="right-panel col-md-4">
        <div>
          <div class="payment-summary">
            <div><span>Tổng tiền hàng</span><span id="total-amount">0</span></div>
            <div><span>Giảm giá</span><span id="discount-amount">0</span></div>
            <div><span>Khách cần trả</span><span class="total-amount" id="final-amount">0</span></div>
          </div>
          <hr />
          <div class="payment-methods text-center">
            <p class="text-muted mb-2">Phương thức</p>
            <div class="btn-group w-100" role="group">
              <button class="btn btn-outline-secondary btn-sm active" id="pm-cash">Tiền mặt</button>
              <button class="btn btn-outline-secondary btn-sm" id="pm-card">Thẻ</button>
              <button class="btn btn-outline-secondary btn-sm" id="pm-qr">Chuyển khoản</button>
            </div>
          </div>
        </div>

        <button class="btn btn-primary btn-lg w-100 mt-3" id="checkout-button">
          THANH TOÁN
        </button>
      </div>
    </div>

    <div class="bottom-bar">
      <div class="text-muted" id="invoice-meta">0 mặt hàng • 0 dòng</div>
      <div class="btn-group">
        <button class="btn btn-outline-secondary btn-sm" id="btn-clear-invoice">
          <i class="fas fa-trash-alt me-1"></i> Xóa giỏ
        </button>
        <button class="btn btn-outline-secondary btn-sm" id="btn-hold-invoice" title="Giữ hóa đơn (chưa thanh toán)">
          <i class="fas fa-bookmark me-1"></i> Giữ hóa đơn
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ====== Config ======
      const API_URL = "https://localhost:7225/api/sales";
      const IMG_FALLBACK_40 = "https://placehold.co/40x40";
      const IMG_FALLBACK_50 = "https://placehold.co/50x50";

      // ====== Auth helpers (đọc từ storage + decode JWT) ======
      function base64UrlDecode(str){
        str = str.replace(/-/g, '+').replace(/_/g, '/');
        const pad = str.length % 4;
        if (pad) str += '='.repeat(4 - pad);
        const decoded = atob(str);
        const bytes = Uint8Array.from(decoded, c => c.charCodeAt(0));
        return new TextDecoder('utf-8').decode(bytes);
      }
      function parseJwt(token){
        try{
          const parts = token.split('.');
          if (parts.length !== 3) return null;
          return JSON.parse(base64UrlDecode(parts[1]));
        }catch{ return null; }
      }
      function getAuthPayload() {
        const raw = localStorage.getItem("authUser") || sessionStorage.getItem("authUser");
        if (raw) { try { return JSON.parse(raw); } catch {} }

        const accessToken =
          localStorage.getItem("accessToken") || sessionStorage.getItem("accessToken") ||
          localStorage.getItem("authToken")   || sessionStorage.getItem("authToken")   || "";
        const tokenType =
          localStorage.getItem("tokenType")   || sessionStorage.getItem("tokenType")   || "Bearer";
        const storeIdStr =
          localStorage.getItem("storeId")     || sessionStorage.getItem("storeId");

        const payload = { accessToken, tokenType };
        if (storeIdStr != null && storeIdStr !== "") payload.storeId = Number(storeIdStr);

        if (accessToken && payload.storeId == null){
          const claims = parseJwt(accessToken) || {};
          const keys = ["storeId", "store_id", "sid", "store", "StoreId", "StoreID"];
          for (const k of keys){
            if (claims[k] != null && claims[k] !== ""){
              const v = Number(claims[k]);
              if (!Number.isNaN(v)){
                payload.storeId = v;
                try { sessionStorage.setItem("storeId", String(v)); } catch {}
                break;
              }
            }
          }
        }
        return accessToken ? payload : null;
      }
      function getAccessToken(){ return getAuthPayload()?.accessToken || ""; }
      function getTokenType(){ return getAuthPayload()?.tokenType || "Bearer"; }
      function getStoreId(){ 
        const v = getAuthPayload()?.storeId;
        return (typeof v === "number" && !Number.isNaN(v)) ? v : null;
      }
      function authHeaders(extra = {}) {
        const h = { "Content-Type": "application/json", ...extra };
        const t = getAccessToken(); const ty = getTokenType();
        if (t) h["Authorization"] = `${ty} ${t}`;
        return h;
      }
      function logout() {
        try { localStorage.clear(); sessionStorage.clear(); }
        finally { window.location.href = "login.html"; }
      }
      function handleAuthError(res){
        if (res.status === 401 || res.status === 403) { alert("Phiên hết hạn. Đăng nhập lại."); logout(); return true; }
        return false;
      }
      document.getElementById("btn-logout").addEventListener("click", (e)=>{ e.preventDefault(); logout(); });

      // ====== UI shortcuts ======
      const VND = new Intl.NumberFormat("vi-VN");
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => [...root.querySelectorAll(sel)];

      const productSearchInput = $("#product-search-input");
      const searchResultsDiv    = $("#search-results");
      const cartItemsContainer  = $("#cart-items-container");
      const emptyCartMessage    = $("#empty-cart-message");
      const totalAmountSpan     = $("#total-amount");
      const discountAmountSpan  = $("#discount-amount");
      const finalAmountSpan     = $("#final-amount");
      const checkoutButton      = $("#checkout-button");
      const invoiceTabsUl       = $("#invoice-tabs");
      const btnAddInvoice       = $("#btn-add-invoice");
      const invoiceMeta         = $("#invoice-meta");
      const btnClearInvoice     = $("#btn-clear-invoice");
      const btnHoldInvoice      = $("#btn-hold-invoice");

      // ====== Invoices ======
      let invoices = [];
      let activeInvoiceId = null;

      function getSmallestAvailableInvoiceNumber() {
        const used = new Set(invoices.map(x => x.num));
        let n = 1; while (used.has(n)) n++; return n;
      }
      function fmt(n){ return VND.format(n || 0) }
      function debounce(func, delay){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>func.apply(this,args),delay); } }

      function createInvoice() {
        const nextNum = getSmallestAvailableInvoiceNumber();
        const inv = { id: crypto.randomUUID(), num: nextNum, name: `Hóa đơn ${nextNum}`, cart: [] };
        invoices.push(inv);
        activeInvoiceId = inv.id;
        renderInvoiceTabs();
        renderCart();
      }
      function getActiveInvoice(){ return invoices.find(x => x.id === activeInvoiceId) }
      function switchInvoice(id){ if(id!==activeInvoiceId){ activeInvoiceId=id; renderInvoiceTabs(); renderCart(); } }
      function closeInvoice(id){
        if(invoices.length===1){ alert("Phải còn ít nhất một hóa đơn."); return; }
        const inv = invoices.find(x=>x.id===id);
        if(inv && inv.cart.length>0){
          if(!confirm(`${inv.name} đang có sản phẩm. Đóng vẫn tiếp tục?`)) return;
        }
        invoices = invoices.filter(x=>x.id!==id);
        if(activeInvoiceId===id) activeInvoiceId = invoices[0].id;
        renderInvoiceTabs(); renderCart();
      }
      function renderInvoiceTabs(){
        invoiceTabsUl.innerHTML = "";
        [...invoices].sort((a,b)=>a.num-b.num).forEach(inv=>{
          const li = document.createElement("li");
          li.className = "nav-item";
          li.innerHTML = `
            <a class="nav-link ${inv.id===activeInvoiceId ? "active fw-semibold":""}" href="#" data-id="${inv.id}" title="Nhấp để chuyển, double-click để đổi tên">
              <i class="fas fa-file-invoice me-1"></i>
              <span class="inv-title">${inv.name}</span>
              <i class="fas fa-times ms-2 small tab-close" data-close-id="${inv.id}"></i>
            </a>`;
          invoiceTabsUl.appendChild(li);
        });
        $$(".nav-link", invoiceTabsUl).forEach(a=>{
          a.addEventListener("click", e=>{ e.preventDefault(); switchInvoice(a.dataset.id) });
          a.addEventListener("dblclick", e=>{
            e.preventDefault();
            const id = a.dataset.id;
            const inv = invoices.find(x=>x.id===id);
            const newName = prompt("Đổi tên hóa đơn:", inv?.name || "");
            if(newName && newName.trim()){ inv.name=newName.trim(); renderInvoiceTabs(); }
          });
        });
        $$(".tab-close", invoiceTabsUl).forEach(btn=>{
          btn.addEventListener("click", e=>{ e.stopPropagation(); closeInvoice(btn.dataset.closeId) });
        });
      }

      // ====== Resolve locationId từ storeId trong payload/JWT ======
      let CURRENT_LOCATION_ID = null;
      async function resolveLocationIdFromStore() {
        const sid = getStoreId();
        console.log("Auth payload:", getAuthPayload());
        if (sid == null) {
          console.warn("Không tìm thấy storeId trong payload; không thể lấy đúng tồn kho. BE sẽ cộng tất cả location nếu không truyền locationId.");
          return;
        }
        try {
          const res = await fetch(`${API_URL}/store-location?storeId=${sid}`, { headers: authHeaders() });
          if (handleAuthError(res)) return;
          if (!res.ok) throw new Error(await res.text());
          const text = await res.text();
          CURRENT_LOCATION_ID = Number(text);
          console.log("locationId:", CURRENT_LOCATION_ID);
        } catch (err) {
          console.error("Không lấy được locationId:", err);
          alert("Không lấy được Location của store. Tồn kho có thể sai.");
        }
      }

      // ====== Search Products (truyền locationId để tồn kho chính xác) ======
      async function searchProducts(q){
        if(!q || !q.trim()){
          searchResultsDiv.classList.add("d-none");
          return;
        }
        try{
          const qs = new URLSearchParams({ q: q.trim() });
          if (CURRENT_LOCATION_ID != null) qs.set("locationId", String(CURRENT_LOCATION_ID));

          const url = `${API_URL}/goods?${qs.toString()}`;
          const res = await fetch(url, { headers: authHeaders() });
          if (handleAuthError(res)) return;

          const text = await res.text();
          if(!res.ok){
            console.error("API error:", res.status, text);
            throw new Error(text || `HTTP ${res.status}`);
          }
          const products = text ? JSON.parse(text) : [];
          displaySearchResults(products || []);
        }catch(err){
          console.error("Lỗi tìm kiếm:", err);
          searchResultsDiv.innerHTML = `<div class="p-2 text-danger">Lỗi API: ${err?.message || err}</div>`;
          searchResultsDiv.classList.remove("d-none");
        }
      }

      function displaySearchResults(products){
        searchResultsDiv.innerHTML = "";
        if(products.length===0){
          searchResultsDiv.innerHTML = `<div class="p-2 text-muted">Không tìm thấy sản phẩm nào.</div>`;
        }else{
          products.forEach(p=>{
            const itemDiv = document.createElement("div");
            itemDiv.classList.add("search-results-item");
            itemDiv.dataset.goodId = p.goodID;
            itemDiv.innerHTML = `
              <img src="${p.imageURL || IMG_FALLBACK_40}" alt="${p.name}">
              <div class="search-results-item-info">
                <div class="search-results-item-name">${p.name}</div>
                <small class="text-muted">Tồn: ${p.quantityAvailable} ${p.unit}</small>
              </div>
              <span class="search-results-item-price">${fmt(Number(p.priceSell||0))} VND</span>
            `;
            itemDiv.addEventListener("click", ()=> addProductToCart(p));
            searchResultsDiv.appendChild(itemDiv);
          });
        }
        searchResultsDiv.classList.remove("d-none");
      }

      // ====== Cart ======
      function addProductToCart(p){
        const inv = getActiveInvoice(); if(!inv) return;
        const cart = inv.cart;
        const exist = cart.find(i=>i.goodID===p.goodID);
        if(exist){
          if(exist.quantityInCart < p.quantityAvailable) exist.quantityInCart++;
          else alert("Không thể thêm vì số lượng tồn kho của "+p.name+" không đủ.");
        }else{
          if(p.quantityAvailable>0){
            cart.push({
              goodID: p.goodID,
              name: p.name,
              priceSell: Number(p.priceSell || 0),
              unit: p.unit,
              imageURL: p.imageURL,
              quantityAvailable: Number(p.quantityAvailable || 0),
              quantityInCart: 1,
              discountPercent: 0
            });
          }else alert("Sản phẩm "+p.name+" đã hết hàng.");
        }
        searchResultsDiv.classList.add("d-none");
        productSearchInput.value = "";
        renderCart();
      }

      function lineGross(item){ return Number(item.priceSell||0) * Number(item.quantityInCart||0) }
      function lineDiscount(item){ return lineGross(item) * (Number(item.discountPercent||0)/100) }
      function lineFinal(item){ return lineGross(item) - lineDiscount(item) }

      function renderCart(){
        const inv = getActiveInvoice(); if(!inv) return;
        const cart = inv.cart;
        cartItemsContainer.innerHTML = "";

        if(cart.length===0){
          emptyCartMessage.classList.remove("d-none");
          cartItemsContainer.appendChild(emptyCartMessage);
        }else{
          emptyCartMessage.classList.add("d-none");
          cart.forEach(item=>{
            const row = document.createElement("div");
            row.className = "cart-item";
            row.dataset.goodId = item.goodID;
            row.innerHTML = `
              <img src="${item.imageURL || IMG_FALLBACK_50}" alt="${item.name}">
              <div class="cart-item-details">
                <div class="cart-item-name" title="${item.name}">${item.name}</div>
                <small>${fmt(item.priceSell)} VND / ${item.unit}</small>
              </div>

              <div class="cart-item-pricing">
                <input type="number" class="form-control form-control-sm price-input" min="0" step="100" value="${item.priceSell}" data-id="${item.goodID}" title="Đơn giá">
                <input type="number" class="form-control form-control-sm discount-input" min="0" max="100" step="0.5" value="${item.discountPercent||0}" data-id="${item.goodID}" title="Giảm giá %">
                <div class="text-end small">
                  <span class="text-muted">Thành tiền:</span>
                  <span class="fw-semibold line-total" data-id="${item.goodID}">${fmt(lineFinal(item))}</span>
                </div>
              </div>

              <div class="cart-item-controls">
                <button class="btn btn-sm btn-outline-secondary decrease-quantity" data-id="${item.goodID}" title="Giảm (−)">-</button>
                <input type="number" class="form-control form-control-sm text-center quantity-in-cart" value="${item.quantityInCart}" min="1" data-id="${item.goodID}">
                <button class="btn btn-sm btn-outline-secondary increase-quantity" data-id="${item.goodID}" title="Tăng (+)">+</button>
                <i class="fas fa-trash-alt cart-item-remove ms-2" data-id="${item.goodID}" title="Xóa dòng"></i>
              </div>
            `;
            cartItemsContainer.appendChild(row);
          });

          $$(".decrease-quantity").forEach(btn=> btn.addEventListener("click", updateCartQuantity));
          $$(".increase-quantity").forEach(btn=> btn.addEventListener("click", updateCartQuantity));
          $$(".quantity-in-cart").forEach(inp=> inp.addEventListener("change", updateCartQuantityManual));
          $$(".cart-item-remove").forEach(icon=> icon.addEventListener("click", removeProductFromCart));
          $$(".price-input").forEach(inp=> inp.addEventListener("change", onPriceChange));
          $$(".discount-input").forEach(inp=> inp.addEventListener("change", onDiscountChange));
        }
        updatePaymentSummary();
        updateInvoiceMeta();
      }

      function onPriceChange(e){
        const inv = getActiveInvoice(); if(!inv) return;
        const id = Number(e.target.dataset.id);
        const item = inv.cart.find(i=>i.goodID===id);
        let v = Number(e.target.value);
        if(isNaN(v) || v<0) v = 0;
        item.priceSell = v;
        renderCart();
      }
      function onDiscountChange(e){
        const inv = getActiveInvoice(); if(!inv) return;
        const id = Number(e.target.dataset.id);
        const item = inv.cart.find(i=>i.goodID===id);
        let v = Number(e.target.value);
        if(isNaN(v) || v<0) v = 0;
        if(v>100) v = 100;
        item.discountPercent = v;
        renderCart();
      }

      function updateCartQuantity(e){
        const inv = getActiveInvoice(); if(!inv) return;
        const id = Number(e.target.dataset.id);
        const inc = e.target.classList.contains("increase-quantity");
        const item = inv.cart.find(i=>i.goodID===id);
        if(!item) return;
        if(inc){
          if(item.quantityInCart < item.quantityAvailable) item.quantityInCart++;
          else alert("Số lượng tồn kho của sản phẩm này không đủ.");
        }else{
          if(item.quantityInCart>1) item.quantityInCart--;
          else { removeById(id); return; }
        }
        renderCart();
      }

      function updateCartQuantityManual(e){
        const inv = getActiveInvoice(); if(!inv) return;
        const id = Number(e.target.dataset.id);
        const item = inv.cart.find(i=>i.goodID===id);
        if(!item) return;
        let q = Number(e.target.value);
        if(isNaN(q) || q<1) q = 1;
        if(q > item.quantityAvailable){
          alert(`Số lượng tồn kho của ${item.name} chỉ còn ${item.quantityAvailable}.`);
          q = item.quantityAvailable;
        }
        item.quantityInCart = q;
        renderCart();
      }

      function removeById(id){
        const inv = getActiveInvoice(); if(!inv) return;
        inv.cart = inv.cart.filter(i=>i.goodID!==id);
        renderCart();
      }
      function removeProductFromCart(e){ removeById(Number(e.target.dataset.id)); }

      function updatePaymentSummary(){
        const inv = getActiveInvoice(); if(!inv) return;
        let gross=0, disc=0, final=0;
        inv.cart.forEach(it=>{
          gross += lineGross(it);
          disc  += lineDiscount(it);
          final += lineFinal(it);
        });
        totalAmountSpan.textContent    = fmt(gross);
        discountAmountSpan.textContent = fmt(disc);
        finalAmountSpan.textContent    = fmt(final);
      }
      function updateInvoiceMeta(){
        const inv = getActiveInvoice(); if(!inv) return;
        const lines = inv.cart.length;
        const items = inv.cart.reduce((s,i)=> s + Number(i.quantityInCart||0), 0);
        invoiceMeta.textContent = `${items} mặt hàng • ${lines} dòng`;
      }

      // ====== Checkout ======
      async function handleCheckout(){
        const inv = getActiveInvoice(); if(!inv) return;
        const cart = inv.cart;
        if(cart.length===0){ alert("Giỏ hàng trống."); return; }
        if(!confirm(`Xác nhận thanh toán cho "${inv.name}"?`)) return;

        try{
          for(const item of cart){
            const payload = { goodID: item.goodID, quantitySold: item.quantityInCart };
            const res = await fetch(`${API_URL}/sell`, {
              method: "POST",
              headers: authHeaders(),
              body: JSON.stringify(payload),
            });
            if (handleAuthError(res)) return;
            if(!res.ok){
              let msg="Không thể thực hiện giao dịch.";
              try{ const data=await res.json(); msg = data?.message || msg; }catch{}
              alert(`Lỗi khi bán ${item.name}: ${msg}`); return;
            }
          }
          alert("Thanh toán thành công!");
          inv.cart = [];
          renderCart();
        }catch(err){
          console.error("Lỗi thanh toán:", err);
          alert("Đã xảy ra lỗi khi kết nối đến server.");
        }
      }

      // ====== Events & init ======
      const hideIfEmpty = ()=>{ if (!productSearchInput.value.trim()) searchResultsDiv.classList.add("d-none"); };
      productSearchInput.addEventListener("input", debounce(e=> { searchProducts(e.target.value); if (!e.target.value) hideIfEmpty(); }, 250));
      productSearchInput.addEventListener("keydown", e=>{
        if(e.key==="Enter"){
          const first = document.querySelector(".search-results-item");
          if(first){ first.click(); e.preventDefault(); }
        }
      });
      document.addEventListener("click", e=>{
        const box = document.getElementById("search-results");
        const input = document.getElementById("product-search-input");
        if(!input.contains(e.target) && !box.contains(e.target)){
          box.classList.add("d-none");
        }
      });
      checkoutButton.addEventListener("click", handleCheckout);
      btnAddInvoice.addEventListener("click", createInvoice);
      btnClearInvoice.addEventListener("click", ()=>{
        const inv=getActiveInvoice(); if(!inv) return;
        if(inv.cart.length===0) return;
        if(confirm("Xóa toàn bộ giỏ hàng hiện tại?")){ inv.cart=[]; renderCart(); }
      });
      btnHoldInvoice.addEventListener("click", ()=> alert("Tính năng giữ hóa đơn (park invoice) sẽ lưu ở localStorage hoặc API (nếu có)."));

      document.addEventListener("keydown", e=>{
        if(e.ctrlKey && e.key.toLowerCase()==="n"){ e.preventDefault(); createInvoice(); }
        if(e.key==="Delete"){
          const active = document.activeElement;
          const wrapper = active?.closest?.(".cart-item");
          if(wrapper){
            const id = Number(wrapper.dataset.goodId);
            removeById(id);
          }
        }
      });

      (async () => {
        await resolveLocationIdFromStore();  
        createInvoice();
      })();
    </script>
  </body>
</html>
