<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sales</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

    <!-- Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- (Tùy chọn) CSS riêng -->
    <link rel="stylesheet" href="css/sales.css"/>

    <style>
      :root{
        --font-sans: "Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        --brand: #0f172a;
        --muted: #64748b;
        --primary: #2563eb;
        --primary-2: #1d4ed8;
        --success: #16a34a;
        --danger: #dc2626;
        --border: #e5e7eb;
        --card: #ffffff;
        --shadow: 0 10px 30px rgba(2,6,23,.08);
      }

      html, body { height: 100%; }
      body{
        font-family: var(--font-sans);
        color: var(--brand);
        background:
          radial-gradient(1000px 600px at 0% -10%, rgba(37,99,235,.06), transparent 60%),
          radial-gradient(1000px 600px at 120% 110%, rgba(29,78,216,.05), transparent 60%),
          #f5f7fb;
      }

      /* Navbar */
      .navbar-custom{
        background: linear-gradient(90deg, #111827, #0b1220);
        box-shadow: 0 4px 18px rgba(2,6,23,.18);
      }

      /* Tabs hoá đơn */
      .invoice-tabs-wrapper{ background:#fff }
      #invoice-tabs .nav-link{
        color:#334155; background:#ffffff; border:1px solid var(--border);
        border-bottom-color: transparent; margin-bottom:-1px; border-radius:.75rem .75rem 0 0;
      }
      #invoice-tabs .nav-link.active{
        color: var(--primary); border-color: var(--primary); border-bottom-color:#fff; font-weight:600;
        background: linear-gradient(180deg, #fff, #f8fbff);
      }
      #invoice-tabs .tab-close{ opacity:.6 }
      #invoice-tabs .tab-close:hover{ opacity:1; color:#ef4444 }

      /* Ô tìm kiếm sản phẩm */
      .search-box .form-control{
        background: #fff; border:1px solid var(--border); border-left:0; border-radius:.75rem;
        box-shadow: none;
      }
      .search-box .input-group-text{
        background:#fff; border:1px solid var(--border); border-right:0; border-radius:.75rem 0 0 .75rem;
      }
      .search-box .form-control:focus{
        border-color: var(--primary); outline:0; box-shadow: 0 0 0 .15rem rgba(37,99,235,.15);
      }

      /* Dropdown gợi ý sản phẩm */
      .search-results-dropdown{
        background:#fff; border:1px solid var(--border); border-radius:.75rem; box-shadow: var(--shadow);
      }
      .search-results-item:hover{ background:#f6f8ff }
      .search-results-item-name{ color:#0f172a }
      .search-results-item-price{ color: var(--primary) }

      /* Giỏ hàng (căn thẳng cột) */
      .cart-header{ color:#64748b }
      .cart-header{
        display: grid;
        grid-template-columns: 1.2fr 0.9fr 1fr;
        column-gap: 12px;
        align-items: center;
      }
      .cart-items-container .cart-item{
        background:#fff; border-bottom:1px solid #f1f5f9;
        display: grid;
        grid-template-columns: 1.2fr 0.9fr 1fr;
        column-gap: 12px; align-items: center; padding: 10px 12px;
      }
      .cart-item .col-name{ display:flex; align-items:center; gap:12px; min-width:0; }
      .cart-item img{ width:50px; height:50px; object-fit:cover; border-radius:.5rem; border:1px solid var(--border); flex:0 0 auto; }
      .cart-item .cart-item-details{ min-width:0; }
      .cart-item .cart-item-name{ font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .cart-item .form-control{ background:#fff; border:1px solid var(--border); border-radius:.5rem; }
      .cart-item .col-pricing .form-control{ margin-bottom:6px; }
      .cart-item .col-pricing .line-total{ display:block; }
      .cart-item .col-qty{
        display:grid; grid-template-columns:auto 64px auto auto; gap:8px; align-items:center; justify-content:end;
      }
      .cart-item .col-qty .form-control{ text-align:center; }
      .cart-item .fa-trash-alt{ cursor:pointer; opacity:.8; }
      .cart-item .fa-trash-alt:hover{ opacity:1; color: var(--danger); }

      /* Card phải */
      .card{ border:none; border-radius: 1rem; box-shadow: var(--shadow) }
      .card-header{ background:#fff; border-bottom:1px solid var(--border) }

      /* Chỉ hiển thị “Khách cần trả” */
      .payment-summary .pay-row{ font-size: 1.25rem; }
      .payment-summary .pay-label{ margin-right: 12px; }
      .payment-summary .pay-amount{ white-space: nowrap; }

      /* Bottom bar */
      .bottom-bar{
        background:#fff; border-top:1px solid var(--border);
        box-shadow: 0 -6px 16px rgba(2,6,23,.06);
        position: sticky; bottom: 0; z-index: 10;
        display:flex; align-items:center; justify-content:space-between;
        padding:10px 16px; margin-top: 8px;
      }

      /* Offcanvas & modal */
      .offcanvas-header{ border-bottom:1px solid var(--border) }
      .offcanvas .form-control, .offcanvas .form-select{ background:#fff; border:1px solid var(--border); border-radius:.5rem; }
      .offcanvas .form-control:focus, .offcanvas .form-select:focus{ border-color: var(--primary); box-shadow: 0 0 0 .1rem rgba(37,99,235,.15) }
      .inv-row:hover { background:#f9fbff; }
      .inv-status, .inv-customer-badge { font-size:.75rem; }
      .modal-content{ border:none; border-radius:1rem; box-shadow:var(--shadow) }
      .modal-header{ border-bottom:1px solid var(--border) }
      .modal-footer{ border-top:1px solid var(--border) }

      #inv-offcanvas.offcanvas-end{ width: min(480px, 100vw); }
      #inv-offcanvas .offcanvas-body{ padding-right: 22px; }
      #inv-offcanvas .table-responsive{ overflow-x: visible; margin-right: 4px; }
      #inv-offcanvas th:last-child, #inv-offcanvas td:last-child{ width:72px; white-space:nowrap; text-align:right; }
      #inv-offcanvas .inv-view-btn{
        min-width:36px; height:32px; padding:0 8px; display:inline-flex; align-items:center; justify-content:center;
      }

      .search-results-item{
        display:flex; align-items:center; justify-content:space-between;
        padding:8px 10px; border-bottom:1px solid #f1f5f9; cursor:pointer;
      }
      .search-results-item img{ width:40px; height:40px; border-radius:.5rem; object-fit:cover; border:1px solid var(--border); }
      .search-results-item-info{ flex:1; min-width:0; padding:0 10px; }
      .search-results-item-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand text-white fw-bold me-4" href="home.html">
          <i class="fas fa-home me-1"></i> Trang chủ
        </a>

        <div class="d-flex align-items-center flex-grow-1 mx-3 gap-2 position-relative">
          <div class="input-group search-box position-relative w-100">
            <span class="input-group-text bg-white border-0" id="search-addon">
              <i class="fas fa-search text-muted"></i>
            </span>
            <input
              type="text"
              class="form-control border-0"
              placeholder="Tìm hàng hóa"
              id="product-search-input"
              aria-label="Search"
              aria-describedby="search-addon"/>
          </div>
          <div id="search-results" class="search-results-dropdown d-none"></div>
        </div>

        <button class="btn btn-outline-light me-2" id="btn-open-invoices" title="Xem hóa đơn">
          <i class="fas fa-receipt"></i>
        </button>

        <div class="dropdown">
          <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Tài khoản và Cài đặt">
            <i class="fas fa-user-circle"></i> 
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Tài khoản</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#" id="btn-logout">
              <i class="fas fa-sign-out-alt me-2"></i> Đăng xuất
            </a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="invoice-tabs-wrapper bg-light border-bottom">
      <ul class="nav nav-tabs nav-pills align-items-center flex-nowrap" id="invoice-tabs"></ul>
    </div>

    <div class="container-fluid position-relative g-0"></div>

    <div class="main-content row g-0">
      <div class="left-panel col-lg-8">
        <!-- KHU KHÁCH HÀNG -->
        <div class="search-customer mb-3 position-relative">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-user"></i></span>
            <input id="customer-search-input" type="text" class="form-control" placeholder="Tìm khách hàng (Tên hoặc SĐT)"/>
            <button class="btn btn-outline-primary" title="Thêm khách hàng" id="btn-add-customer">
              <i class="fas fa-plus"></i>
            </button>
            <button class="btn btn-outline-secondary d-none" title="Bỏ khách hàng" id="btn-clear-customer">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="selected-customer" class="mt-1 small text-success d-none"></div>
          <div id="customer-suggest" class="position-absolute bg-white border rounded shadow-sm mt-1 d-none"></div>
        </div>
        
        <!-- Giỏ -->
        <div id="cart-items-container" class="cart-items-container">
          <div id="empty-cart-message" class="text-center text-muted p-5 d-none">
            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
            <h5>Giỏ hàng trống</h5>
            <p>Tìm và thêm sản phẩm từ thanh tìm kiếm.</p>
          </div>
        </div>
      </div>

      <div class="right-panel col-lg-4">
        <div class="card shadow-sm mb-3">
          <div class="card-header fw-semibold"><i class="fas fa-file-invoice-dollar me-2"></i> Tóm tắt Thanh toán</div>
          <div class="card-body payment-summary">
            <div class="pay-row d-flex align-items-center justify-content-between">
              <span class="pay-label">Khách cần trả:</span>
              <span class="pay-amount fw-bold text-primary" id="final-amount">0 VND</span>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn btn-lg btn-success w-100 fw-bold" id="checkout-button">
              THANH TOÁN
              <i class="fas fa-chevron-right ms-2"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom bar -->
    <div class="bottom-bar">
      <div class="text-muted" id="invoice-meta">0 mặt hàng • 0 dòng</div>
      <div class="btn-group">
        <button class="btn btn-outline-warning btn-sm" id="btn-hold-invoice" title="Giữ hóa đơn (chưa lưu)">
          <i class="fas fa-pause me-1"></i> Giữ hóa đơn
        </button>
        <button class="btn btn-outline-danger btn-sm" id="btn-clear-invoice">
          <i class="fas fa-trash-alt me-1"></i> Xóa giỏ
        </button>
      </div>
    </div>

    <!-- Offcanvas: Danh sách Hóa đơn -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="inv-offcanvas" aria-labelledby="invOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="invOffcanvasLabel"><i class="fas fa-receipt me-2"></i>Danh sách Hóa đơn</h5>
        <button type="button" class="btn btn-link btn-sm text-muted btn-clear-filter" id="inv-clear-filters">Xóa lọc</button>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <!-- Filters -->
        <div class="row g-2 mb-3">
          <div class="col-12">
            <label class="form-label small text-muted mb-1">Từ khóa (mã/ghi chú)</label>
            <input type="text" id="inv-keyword" class="form-control form-control-sm" placeholder="Nhập từ khóa...">
          </div>
          <div class="col-12 position-relative">
            <label class="form-label small text-muted mb-1">Khách hàng (tên/SĐT)</label>
            <div class="input-group input-group-sm">
              <input type="text" id="inv-cus-input" class="form-control" placeholder="Tìm khách hàng...">
              <button class="btn btn-outline-secondary" type="button" id="inv-cus-clear" title="Bỏ chọn khách"><i class="fas fa-times"></i></button>
            </div>
            <div id="inv-cus-chosen" class="form-text"></div>
            <div id="inv-cus-suggest" class="inv-suggest d-none"></div>
          </div>
          <div class="col-6">
            <label class="form-label small text-muted mb-1">Từ ngày</label>
            <input type="date" id="inv-from" class="form-control form-control-sm">
          </div>
          <div class="col-6">
            <label class="form-label small text-muted mb-1">Đến ngày</label>
            <input type="date" id="inv-to" class="form-control form-control-sm">
          </div>
          <div class="col-6">
            <label class="form-label small text-muted mb-1">Trạng thái</label>
            <select id="inv-status" class="form-select form-select-sm">
              <option value="">Tất cả</option>
              <option value="Completed">Completed</option>
              <option value="Draft">Draft</option>
              <option value="Voided">Voided</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label small text-muted mb-1">Mỗi trang</label>
            <select id="inv-page-size" class="form-select form-select-sm">
              <option>10</option><option>20</option><option>50</option>
            </select>
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-primary btn-sm" id="inv-search-btn"><i class="fas fa-search me-1"></i>Tìm hóa đơn</button>
          </div>
        </div>

        <!-- Summary -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small text-muted" id="inv-summary">—</div>
          <div class="btn-group btn-group-sm" role="group" aria-label="Pagination">
            <button class="btn btn-outline-secondary" id="inv-prev">Trước</button>
            <button class="btn btn-outline-secondary" id="inv-next">Sau</button>
          </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:120px;">Mã</th>
                <th>Khách hàng</th>
                <th class="text-end">Tổng</th>
                <th style="width:140px;">Ngày</th>
                <th style="width:110px;">Trạng thái</th>
                <th style="width:56px;"></th>
              </tr>
            </thead>
            <tbody id="inv-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal: Xem chi tiết Hóa đơn -->
    <div class="modal fade" id="invoiceViewModal" tabindex="-1" aria-labelledby="invoiceViewModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="invoiceViewModalLabel"><i class="fas fa-file-invoice me-2"></i>Hóa đơn</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="inv-view-meta" class="mb-3 small text-muted">—</div>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Sản phẩm</th>
                    <th class="text-end">SL</th>
                    <th class="text-end">Đơn giá</th>
                    <th class="text-end">Thành tiền (sau giảm dòng)</th>
                  </tr>
                </thead>
                <tbody id="inv-view-rows"></tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="text-end">TỔNG CỘNG (Chưa VAT)</th>
                    <th class="text-end" id="inv-view-gross">0 VND</th>
                  </tr>
                  <!-- <tr>
                    <th colspan="3" class="text-end">Giảm theo dòng</th>
                    <th class="text-end text-danger" id="inv-view-itemdisc">0 VND</th>
                  </tr>
                  <tr>
                    <th colspan="3" class="text-end">Tạm tính sau giảm</th>
                    <th class="text-end" id="inv-view-subtotal">0 VND</th>
                  </tr> -->
                  <tr>
                    <th colspan="3" class="text-end">VAT 10% (mức hóa đơn)</th>
                    <th class="text-end" id="inv-view-extradisc">0 VND</th>
                  </tr>
                  <tr>
                    <th colspan="3" class="text-end">KHÁCH CẦN TRẢ</th>
                    <th class="text-end fw-bold text-primary" id="inv-view-total">0 VND</th>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div id="inv-view-extra" class="small text-muted"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Chọn phương thức thanh toán -->
    <div class="modal fade" id="paymentMethodModal" tabindex="-1" aria-labelledby="paymentMethodModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="paymentMethodModalLabel">Chọn Phương Thức Thanh Toán</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="pmethod" id="pmCash" value="CASH" checked>
              <label class="form-check-label" for="pmCash">
                <i class="fas fa-money-bill-wave me-2"></i> Tiền mặt
              </label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="pmethod" id="pmBank" value="BANK">
              <label class="form-check-label" for="pmBank">
                <i class="fas fa-university me-2"></i> Chuyển khoản ngân hàng
              </label>
            </div>

            <div id="pm-bank-area" class="mt-3 p-3 border rounded d-none">
              <div class="mb-2">
                <label for="pm-bank" class="form-label small text-muted">Ngân hàng nhận:</label>
                <select id="pm-bank" class="form-select form-select-sm">
                  <option value="VIETCOMBANK">Vietcombank</option>
                  <option value="ACB">ACB</option>
                  <option value="TECHCOMBANK">Techcombank</option>
                  <option value="MBBANK">MBBank</option>
                  <option value="OTHER">Khác</option>
                </select>
              </div>
              <div class="mb-2">
                <label for="pm-account" class="form-label small text-muted">Số tài khoản:</label>
                <input type="text" class="form-control form-control-sm" id="pm-account" placeholder="VD: 0011001234567">
              </div>
              <div>
                <label for="pm-tx" class="form-label small text-muted">Mã giao dịch/Tham chiếu (nếu có):</label>
                <input type="text" class="form-control form-control-sm" id="pm-tx" placeholder="Mã tham chiếu giao dịch">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            <button type="button" class="btn btn-primary" id="pm-next">Tiếp tục <i class="fas fa-arrow-right ms-1"></i></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Xem trước hóa đơn -->
    <div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-labelledby="invoicePreviewModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="invoicePreviewModalLabel">Xem Trước Hóa Đơn & Xác Nhận</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="small text-muted mb-1">Phương thức thanh toán: <span id="invoice-payment-summary" class="fw-semibold">Tiền mặt</span></p>

            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Sản phẩm</th>
                    <th class="text-end">SL</th>
                    <th class="text-end">Đơn giá</th>
                    <th class="text-end">Thành tiền (sau giảm dòng)</th>
                  </tr>
                </thead>
                <tbody id="invoice-preview-rows"></tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="text-end">TỔNG CỘNG (Chưa VAT)</th>
                    <th class="text-end" id="inv-prev-gross">0 VND</th>
                  </tr>
                  <tr>
                    <th colspan="3" class="text-end">Giảm theo dòng</th>
                    <th class="text-end text-danger" id="inv-prev-itemdisc">0 VND</th>
                  </tr>
                  <tr>
                    <th colspan="3" class="text-end">Tạm tính sau giảm</th>
                    <th class="text-end" id="inv-prev-subtotal">0 VND</th>
                  </tr>
                  <tr>
                    <th colspan="3" class="text-end">VAT 10% (mức hóa đơn)</th>
                    <th class="text-end" id="inv-prev-extradisc">0 VND</th>
                  </tr>
                  <tr>
                    <th colspan="3" class="text-end">KHÁCH CẦN TRẢ</th>
                    <th class="text-end fw-bold text-primary" id="invoice-preview-final">0 VND</th>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="mt-3 border p-3 rounded">
              <label for="invoice-email" class="form-label small text-muted">Gửi hóa đơn qua Email (tùy chọn):</label>
              <div class="input-group">
                <input type="email" class="form-control form-control-sm" id="invoice-email" placeholder="email@khachhang.com">
                <button class="btn btn-outline-secondary btn-sm" type="button" id="btn-send-invoice-email" title="Gửi hóa đơn">
                  <i class="fas fa-envelope"></i>
                </button>
              </div>
            </div>
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Quay lại/Hủy</button>
            <button type="button" class="btn btn-success fw-bold" id="btn-confirm-checkout">
              <i class="fas fa-check-circle me-1"></i> Xác nhận Thanh toán
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Thêm khách hàng -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addCustomerModalLabel">Thêm khách hàng</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Họ tên <span class="text-danger">*</span></label>
              <input type="text" id="add-cus-name" class="form-control" placeholder="VD: Nguyễn Văn A">
            </div>
            <div class="mb-3">
              <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
              <input type="text" id="add-cus-phone" class="form-control" placeholder="VD: 0912345678">
            </div>
            <div class="mb-2">
              <label class="form-label">Email</label>
              <input type="email" id="add-cus-email" class="form-control" placeholder="email@domain.com">
            </div>
            <small class="text-muted">Các trường có dấu * là bắt buộc.</small>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button type="button" class="btn btn-primary" id="btn-save-customer">Lưu</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ====== Config ======
      const API_BASE = "https://localhost:7225";
      const API_SALES = API_BASE + "/api/Sales";
      const API_INVOICE = API_SALES + "/invoice";
      const API_CUSTOMERS = API_BASE + "/api/customers";
      const API_INVOICES = API_SALES + "/invoices";
      const IMG_FALLBACK_40 = "https://placehold.co/40x40";
      const IMG_FALLBACK_50 = "https://placehold.co/50x50";

      // ====== Auth helpers ======
      function base64UrlDecode(str){
        str = str.replace(/-/g, '+').replace(/_/g, '/');
        const pad = str.length % 4;
        if (pad) str += '='.repeat(4 - pad);
        const decoded = atob(str);
        const bytes = Uint8Array.from(decoded, c => c.charCodeAt(0));
        return new TextDecoder('utf-8').decode(bytes);
      }
      function parseJwt(token){
        try{
          const parts = token.split('.');
          if (parts.length !== 3) return null;
          return JSON.parse(base64UrlDecode(parts[1]));
        }catch{ return null; }
      }
      function getAuthPayload() {
        const raw = localStorage.getItem("authUser") || sessionStorage.getItem("authUser");
        if (raw) { try { return JSON.parse(raw); } catch {} }

        const accessToken =
          localStorage.getItem("accessToken") || sessionStorage.getItem("accessToken") ||
          localStorage.getItem("authToken")   || sessionStorage.getItem("authToken")   || "";
        const tokenType =
          localStorage.getItem("tokenType")   || sessionStorage.getItem("tokenType")   || "Bearer";
        const storeIdStr =
          localStorage.getItem("storeId")     || sessionStorage.getItem("storeId");

        const payload = { accessToken, tokenType };
        if (storeIdStr != null && storeIdStr !== "") payload.storeId = Number(storeIdStr);

        if (accessToken && payload.storeId == null){
          const claims = parseJwt(accessToken) || {};
          const keys = ["storeId", "store_id", "sid", "store", "StoreId", "StoreID"];
          for (const k of keys){
            if (claims[k] != null && claims[k] !== ""){
              const v = Number(claims[k]);
              if (!Number.isNaN(v)){
                payload.storeId = v;
                try { sessionStorage.setItem("storeId", String(v)); } catch {}
                break;
              }
            }
          }
        }
        return accessToken ? payload : null;
      }
      function getAccessToken(){ return getAuthPayload()?.accessToken || ""; }
      function getTokenType(){ return getAuthPayload()?.tokenType || "Bearer"; }
      function getStoreId(){ 
        const v = getAuthPayload()?.storeId;
        return (typeof v === "number" && !Number.isNaN(v)) ? v : null;
      }
      function authHeaders(extra = {}) {
        const h = { "Content-Type": "application/json", "Accept": "application/json", ...extra };
        const t = getAccessToken(); const ty = getTokenType();
        if (t) h["Authorization"] = `${ty} ${t}`;
        return h;
      }
      function logout() {
        try { localStorage.clear(); sessionStorage.clear(); }
        finally { window.location.href = "login.html"; }
      }
      function handleAuthError(res){
        if (res.status === 401 || res.status === 403) { alert("Phiên hết hạn. Đăng nhập lại."); logout(); return true; }
        return false;
      }
      document.getElementById("btn-logout").addEventListener("click", (e)=>{ e.preventDefault(); logout(); });

      // ====== UI helpers ======
      const VND = new Intl.NumberFormat("vi-VN");
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => [...root.querySelectorAll(sel)];
      function fmt(n){ return VND.format(n || 0) }
      function num(x){
        if (typeof x === 'number' && isFinite(x)) return x;
        if (x == null) return 0;
        if (typeof x === 'string'){
          const cleaned = x.replace(/[^\d-]/g,'');
          const n = parseInt(cleaned,10);
          return Number.isNaN(n) ? 0 : n;
        }
        const n = Number(x);
        return Number.isNaN(n) ? 0 : n;
      }
      function debounce(func, delay){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>func.apply(this,args),delay); } }
      function cloneDeep(obj){ try { return JSON.parse(JSON.stringify(obj)); } catch { return null; } }
      function toDateStr(d){ try{ return new Date(d).toLocaleString('vi-VN'); }catch{ return String(d||''); } }

      const productSearchInput = $("#product-search-input");
      const searchResultsDiv    = $("#search-results");
      const cartItemsContainer  = $("#cart-items-container");
      const emptyCartMessage    = $("#empty-cart-message");
      const finalAmountSpan     = $("#final-amount");
      const checkoutButton      = $("#checkout-button");
      const invoiceTabsUl       = $("#invoice-tabs");
      const invoiceMeta         = $("#invoice-meta");
      const btnClearInvoice     = $("#btn-clear-invoice");
      const btnHoldInvoice      = $("#btn-hold-invoice");

      // Customer UI refs
      const customerSearchInput = $("#customer-search-input");
      const customerSuggestDiv  = $("#customer-suggest");
      const selectedCustomerDiv = $("#selected-customer");
      const btnClearCustomer    = $("#btn-clear-customer");
      const btnAddCustomer      = $("#btn-add-customer");

      // Add-Customer modal refs
      let addCustomerModal;
      const addCusName  = () => $("#add-cus-name");
      const addCusPhone = () => $("#add-cus-phone");
      const addCusEmail = () => $("#add-cus-email");
      const btnSaveCustomer = () => $("#btn-save-customer");

      // ====== Invoices (POS tabs) ======
      let invoices = [];
      let activeInvoiceId = null;

      function getSmallestAvailableInvoiceNumber() {
        const used = new Set(invoices.map(x => x.num));
        let n = 1; while (used.has(n)) n++; return n;
      }

      function createInvoice() {
        const nextNum = getSmallestAvailableInvoiceNumber();
        let inv = null;
        try {
          const stored = JSON.parse(localStorage.getItem(`pos_invoice_${nextNum}`));
          if (stored && stored.cart) {
            inv = stored;
            inv.id = crypto.randomUUID();
          }
        } catch {}

        if (!inv) {
          inv = { id: crypto.randomUUID(), num: nextNum, name: `Hóa đơn ${nextNum}`, cart: [], customer: null };
        } else if (!('customer' in inv)) {
          inv.customer = null;
        }
        
        invoices.push(inv);
        activeInvoiceId = inv.id;
        renderInvoiceTabs();
        renderCart();
        renderCustomerArea();
      }
      function getActiveInvoice(){ return invoices.find(x => x.id === activeInvoiceId) }
      function switchInvoice(id){ 
        if(id!==activeInvoiceId){ 
          const oldInv = getActiveInvoice();
          if (oldInv) {
            try { localStorage.setItem(`pos_invoice_${oldInv.num}`, JSON.stringify(oldInv)); } catch {}
          }
          activeInvoiceId=id; 
          renderInvoiceTabs(); 
          renderCart(); 
          renderCustomerArea();
        } 
      }
      function closeInvoice(id){
        if(invoices.length===1){ alert("Phải còn ít nhất một hóa đơn."); return; }
        const inv = invoices.find(x=>x.id===id);
        const invIndex = invoices.findIndex(x => x.id === id);
        let nextActiveId = null;
        if (activeInvoiceId === id) nextActiveId = invIndex === 0 ? invoices[1]?.id : invoices[invIndex - 1]?.id;
        invoices = invoices.filter(x=>x.id!==id);
        if(activeInvoiceId===id) activeInvoiceId = nextActiveId || invoices[0].id;
        renderInvoiceTabs(); 
        renderCart();
        renderCustomerArea();
        if (inv) { try { localStorage.removeItem(`pos_invoice_${inv.num}`); } catch {} }
      }
      function renderInvoiceTabs(){
        invoiceTabsUl.innerHTML = "";
        [...invoices].sort((a,b)=>a.num-b.num).forEach(inv=>{
          const li = document.createElement("li");
          li.className = "nav-item me-1";
          const badge = inv.cart.length > 0 ? `<span class="badge bg-danger ms-1 inv-badge">${inv.cart.length}</span>` : '';
          li.innerHTML = `
            <a class="nav-link ${inv.id===activeInvoiceId ? "active fw-semibold":""}" href="#" data-id="${inv.id}" data-num="${inv.num}" title="Nhấp để chuyển, double-click để đổi tên">
              <i class="fas fa-file-invoice me-1"></i>
              <span class="inv-title">${inv.name}</span>
              ${badge}
              <i class="fas fa-times ms-2 small tab-close" data-close-id="${inv.id}"></i>
            </a>`;
          invoiceTabsUl.appendChild(li);
        });

        const liAdd = document.createElement("li");
        liAdd.className = "nav-item ms-1";
        liAdd.innerHTML = `
          <button class="btn btn-outline-primary btn-sm" id="btn-add-invoice" type="button" title="Thêm hóa đơn (Ctrl+N)">
            <i class="fas fa-plus"></i>
          </button>`;
        invoiceTabsUl.appendChild(liAdd);
        
        document.getElementById("btn-add-invoice").addEventListener("click", createInvoice);

        $$(".nav-link", invoiceTabsUl).forEach(a=>{
          a.addEventListener("click", e=>{ e.preventDefault(); switchInvoice(a.dataset.id) });
          a.addEventListener("dblclick", e=>{
            e.preventDefault();
            const id = a.dataset.id;
            const inv = invoices.find(x=>x.id===id);
            const newName = prompt("Đổi tên hóa đơn:", inv?.name || "");
            if(newName && newName.trim()){ inv.name=newName.trim(); renderInvoiceTabs(); }
          });
        });
        $$(".tab-close", invoiceTabsUl).forEach(btn=>{
          btn.addEventListener("click", e=>{ e.stopPropagation(); closeInvoice(btn.dataset.closeId) });
        });
      }

      // ====== Resolve locationId từ storeId ======
      let CURRENT_LOCATION_ID = null;
      async function resolveLocationIdFromStore() {
        const sid = getStoreId();
        if (sid == null) { console.warn("Không tìm thấy storeId trong payload."); return; }
        try {
          const res = await fetch(`${API_SALES}/store-location?storeId=${sid}`, { headers: authHeaders() });
          if (handleAuthError(res)) return;
          if (!res.ok) throw new Error(await res.text());
          const text = await res.text();
          CURRENT_LOCATION_ID = Number(text);
        } catch (err) {
          console.error("Không lấy được locationId:", err);
          alert("Không lấy được Location của store. Tồn kho có thể sai.");
        }
      }

      // ====== Search Products ======
      async function searchProducts(q){
        if(!q || !q.trim()){ searchResultsDiv.classList.add("d-none"); return; }
        try{
          const qs = new URLSearchParams({ q: q.trim() });
          if (CURRENT_LOCATION_ID != null) qs.set("locationId", String(CURRENT_LOCATION_ID));

          const url = `${API_SALES}/goods?${qs.toString()}`;
          const res = await fetch(url, { headers: authHeaders() });
          if (handleAuthError(res)) return;

          const text = await res.text();
          if(!res.ok){ console.error("API error:", res.status, text); throw new Error(text || `HTTP ${res.status}`); }
          const products = text ? JSON.parse(text) : [];
          displaySearchResults(products || []);
        }catch(err){
          console.error("Lỗi tìm kiếm:", err);
          searchResultsDiv.innerHTML = `<div class="p-2 text-danger">Lỗi API: ${err?.message || err}</div>`;
          searchResultsDiv.classList.remove("d-none");
        }
      }

      function displaySearchResults(products){
        searchResultsDiv.innerHTML = "";
        if(!Array.isArray(products) || products.length===0){
          searchResultsDiv.innerHTML = `<div class="p-2 text-muted">Không tìm thấy sản phẩm nào.</div>`;
        }else{
          products.forEach(p=>{
            const itemDiv = document.createElement("div");
            itemDiv.classList.add("search-results-item");
            itemDiv.dataset.goodId = p.goodID || p.GoodID;
            itemDiv.innerHTML = `
              <img src="${p.imageURL || IMG_FALLBACK_40}" alt="${p.name}">
              <div class="search-results-item-info">
                <div class="search-results-item-name">${p.name}</div>
                <small class="text-muted">Tồn: ${p.quantityAvailable ?? 0} ${p.unit || ""}</small>
              </div>
              <span class="search-results-item-price">${fmt(Number(p.priceSell||0))} VND</span>
            `;
            itemDiv.addEventListener("click", ()=> addProductToCart(p));
            searchResultsDiv.appendChild(itemDiv);
          });
        }
        searchResultsDiv.classList.remove("d-none");
      }

      // ====== Cart ======
      function addProductToCart(p){
        const inv = getActiveInvoice(); if(!inv) return;
        const cart = inv.cart;
        const pID = Number(p.goodID || p.GoodID);
        const exist = cart.find(i=>Number(i.goodID || i.GoodID)===pID);
        const available = Number(p.quantityAvailable || 0);

        if(exist){
          if(exist.quantityInCart < available) exist.quantityInCart++;
          else alert("Không thể thêm vì số lượng tồn kho của "+p.name+" không đủ.");
        }else{
          if(available>0){
            cart.push({
              goodID: pID,
              name: p.name,
              priceSell: Number(p.priceSell || 0),
              unit: p.unit,
              imageURL: p.imageURL,
              quantityAvailable: available,
              quantityInCart: 1,
              discountPercent: 0 // GIẢM THEO DÒNG (%)
            });
          }else alert("Sản phẩm "+p.name+" đã hết hàng.");
        }
        searchResultsDiv.classList.add("d-none");
        productSearchInput.value = "";
        renderCart();
      }

      function lineGross(item){ return Number(item.priceSell||0) * Number(item.quantityInCart||0) }
      function lineDiscount(item){ return lineGross(item) * (Number(item.discountPercent||0)/100) }
      function lineFinal(item){ return lineGross(item) - lineDiscount(item) }

      // === Giảm theo dòng -> rồi VAT tổng 10% (cộng) ===
      const GLOBAL_VAT_PERCENT = 10; // %
      function computeTotals(inv){
        let gross = 0;      // tổng tiền trước VAT, trước giảm
        let itemDisc = 0;   // tổng giảm theo dòng
        for (const it of (inv?.cart || [])) {
          const q = Number(it.quantityInCart || 0);
          const price = Number(it.priceSell || 0);
          const g = price * q;
          const d = g * (Number(it.discountPercent || 0) / 100);
          gross += g; itemDisc += d;
        }
        const subtotal = gross - itemDisc;                         // sau giảm dòng
        const extraVat = Math.round(subtotal * GLOBAL_VAT_PERCENT / 100); // VAT mức hóa đơn
        const finalToPay = subtotal + extraVat;
        return { gross, itemDisc, subtotal, extraVat, finalToPay };
      }

      function renderCart(){
        const inv = getActiveInvoice(); 
        if(!inv) return;
        const cart = inv.cart;
        cartItemsContainer.innerHTML = "";

        if(cart.length===0){
          emptyCartMessage.classList.remove("d-none");
          cartItemsContainer.appendChild(emptyCartMessage);
        }else{
          emptyCartMessage.classList.add("d-none");
          const cartHeader = document.querySelector('.cart-header');
          if(cartHeader) cartHeader.style.display = 'flex';
          
          cart.forEach(item=>{
            const row = document.createElement("div");
            row.className = "cart-item";
            row.dataset.goodId = item.goodID;
            
            const itemPriceSell = Number(item.priceSell || 0);
            const itemDiscountPercent = Number(item.discountPercent || 0);

            row.innerHTML = `
              <div class="col-name">
                <img src="${item.imageURL || IMG_FALLBACK_50}" alt="${item.name}">
                <div class="cart-item-details">
                  <div class="cart-item-name" title="${item.name}">${item.name}</div>
                  <small>${fmt(itemPriceSell)} VND / ${item.unit || ''}</small>
                </div>
              </div>

              <div class="col-pricing">
                <input type="number" class="form-control form-control-sm price-input" min="0" step="100" value="${itemPriceSell}" data-id="${item.goodID}" title="Đơn giá">
                <input type="number" class="form-control form-control-sm discount-input" min="0" max="100" step="0.5" value="${itemDiscountPercent}" data-id="${item.goodID}" title="Giảm giá %">
                <div class="text-end small">
                  <span class="text-muted">Thành tiền:</span>
                  <span class="fw-semibold line-total" data-id="${item.goodID}">${fmt(lineFinal(item))}</span>
                </div>
              </div>

              <div class="col-qty">
                <button class="btn btn-sm btn-outline-secondary decrease-quantity" data-id="${item.goodID}" title="Giảm (−)">-</button>
                <input type="number" class="form-control form-control-sm quantity-in-cart" value="${item.quantityInCart}" min="1" data-id="${item.goodID}">
                <button class="btn btn-sm btn-outline-secondary increase-quantity" data-id="${item.goodID}" title="Tăng (+)">+</button>
                <i class="fas fa-trash-alt cart-item-remove" data-id="${item.goodID}" title="Xóa dòng"></i>
              </div>
            `;
            cartItemsContainer.appendChild(row);
          });

          $$(".decrease-quantity").forEach(btn=> btn.addEventListener("click", updateCartQuantity));
          $$(".increase-quantity").forEach(btn=> btn.addEventListener("click", updateCartQuantity));
          $$(".quantity-in-cart").forEach(inp=> inp.addEventListener("change", updateCartQuantityManual));
          $$(".cart-item-remove").forEach(icon=> icon.addEventListener("click", removeProductFromCart));
          $$(".price-input").forEach(inp=> inp.addEventListener("change", onPriceChange));
          $$(".discount-input").forEach(inp=> inp.addEventListener("change", onDiscountChange));
        }

        const cartHeader = document.querySelector('.cart-header');
        if(cartHeader) cartHeader.style.display = cart.length === 0 ? 'none' : 'flex';
        
        updatePaymentSummary();
        updateInvoiceMeta();
        renderInvoiceTabs();
      }

      function onPriceChange(e){
        const inv = getActiveInvoice(); if(!inv) return;
        const id = Number(e.target.dataset.id);
        const item = inv.cart.find(i=>i.goodID===id);
        let v = Number(e.target.value);
        if(isNaN(v) || v<0) v = 0;
        item.priceSell = v;
        renderCart();
      }
      function onDiscountChange(e){
        const inv = getActiveInvoice(); if(!inv) return;
        const id = Number(e.target.dataset.id);
        const item = inv.cart.find(i=>i.goodID===id);
        let v = Number(e.target.value);
        if(isNaN(v) || v<0) v = 0;
        if(v>100) v = 100;
        item.discountPercent = v; // giảm theo dòng
        renderCart();
      }

      function updateCartQuantity(e){
        const inv = getActiveInvoice(); if(!inv) return;
        const id = Number(e.target.dataset.id);
        const inc = e.target.classList.contains("increase-quantity");
        const item = inv.cart.find(i=>i.goodID===id);
        if(!item) return;
        if(inc){
          if(item.quantityInCart < item.quantityAvailable) item.quantityInCart++;
          else alert("Số lượng tồn kho của sản phẩm này không đủ.");
        }else{
          if(item.quantityInCart>1) item.quantityInCart--;
          else { removeById(id); return; }
        }
        renderCart();
      }

      function updateCartQuantityManual(e){
        const inv = getActiveInvoice(); if(!inv) return;
        const id = Number(e.target.dataset.id);
        const item = inv.cart.find(i=>i.goodID===id);
        if(!item) return;
        let q = Number(e.target.value);
        if(isNaN(q) || q<1) q = 1;
        if(q > item.quantityAvailable){
          alert(`Số lượng tồn kho của ${item.name} chỉ còn ${item.quantityAvailable}.`);
          q = item.quantityAvailable;
        }
        item.quantityInCart = q;
        renderCart();
      }

      function removeById(id){
        const inv = getActiveInvoice(); if(!inv) return;
        inv.cart = inv.cart.filter(i=>i.goodID!==id);
        renderCart();
      }
      function removeProductFromCart(e){ removeById(Number(e.target.dataset.id)); }

      // ====== Summary phải ======
      function updatePaymentSummary(){
        const inv = getActiveInvoice(); 
        if (!inv) return;
        const t = computeTotals(inv);
        finalAmountSpan.textContent = fmt(t.finalToPay) + ' VND';
      }

      function updateInvoiceMeta(){
        const inv = getActiveInvoice(); if(!inv) return;
        const lines = inv.cart.length;
        const items = inv.cart.reduce((s,i)=> s + Number(i.quantityInCart||0), 0);
        invoiceMeta.textContent = `${items} mặt hàng • ${lines} dòng`;
      }

      // ====== Khách hàng ======
      function renderCustomerArea(){
        const inv = getActiveInvoice();
        if (!inv) return;

        if (inv.customer){
          selectedCustomerDiv.classList.remove("d-none");
          btnClearCustomer.classList.remove("d-none");
          selectedCustomerDiv.textContent =
            `${inv.customer.name} ${inv.customer.phone ? '('+inv.customer.phone+')' : ''}`;
          customerSuggestDiv.classList.add("d-none");
          customerSuggestDiv.innerHTML = '';
          customerSearchInput.value = '';
        } else {
          selectedCustomerDiv.classList.add("d-none");
          btnClearCustomer.classList.add("d-none");
        }
      }
      btnClearCustomer.addEventListener("click", () => {
        const inv = getActiveInvoice(); if(!inv) return;
        inv.customer = null;
        renderCustomerArea();
        try { localStorage.setItem(`pos_invoice_${inv.num}`, JSON.stringify(inv)); } catch {}
      });

      async function searchCustomers(q){
        if(!q || !q.trim()){
          customerSuggestDiv.classList.add('d-none');
          customerSuggestDiv.innerHTML = '';
          return;
        }
        try{
          const url = `${API_CUSTOMERS}/search?q=${encodeURIComponent(q.trim())}`;
          const res = await fetch(url, { headers: authHeaders() });
          if (handleAuthError(res)) return;
          if(!res.ok) throw new Error(await res.text());
          const list = await res.json();
          renderCustomerSuggest(list);
        }catch(err){
          console.error(err);
          customerSuggestDiv.classList.add('d-none');
          customerSuggestDiv.innerHTML = '';
        }
      }
      function renderCustomerSuggest(list){
        customerSuggestDiv.innerHTML = '';
        if(!Array.isArray(list) || list.length===0){
          customerSuggestDiv.classList.add('d-none');
          return;
        }
        list.forEach(c=>{
          const li = document.createElement('div');
          li.className = 'px-2 py-2 border-bottom customer-suggest-item';
          li.style.cursor = 'pointer';
          li.innerHTML = `<div class="fw-semibold">${c.name}</div>
                          <div class="text-muted small">${c.phoneNumber || ''} ${c.email ? ' • '+c.email : ''}</div>`;
          li.addEventListener('click', ()=> chooseCustomer(c));
          customerSuggestDiv.appendChild(li);
        });
        customerSuggestDiv.classList.remove('d-none');
      }
      function chooseCustomer(cus){
        const inv = getActiveInvoice(); if(!inv) return;
        inv.customer = {
          id: cus.customerID,
          name: cus.name,
          phone: cus.phoneNumber || null,
          email: cus.email || null
        };
        renderCustomerArea();
        try { localStorage.setItem(`pos_invoice_${inv.num}`, JSON.stringify(inv)); } catch {}
      }

      // Modal thêm khách hàng
      btnAddCustomer.addEventListener('click', () => { addCustomerModal?.show(); });
      async function addCustomer(){
        const nm = (addCusName().value || '').trim();
        const ph = (addCusPhone().value || '').trim();
        const em = (addCusEmail().value || '').trim();
        if(!nm || !ph){ alert("Vui lòng nhập Họ tên và Số điện thoại."); return; }
        try{
          const res = await fetch(`${API_CUSTOMERS}`, {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify({ name: nm, phoneNumber: ph, email: em || null })
          });
          if (handleAuthError(res)) return;
          if(!res.ok) throw new Error(await res.text());
          const c = await res.json();
          addCusName().value = ""; addCusPhone().value = ""; addCusEmail().value = "";
          addCustomerModal?.hide();
          chooseCustomer(c);
        }catch(err){
          alert("Không thêm được khách hàng: " + (err?.message || err));
        }
      }
      btnSaveCustomer().addEventListener('click', addCustomer);

      // ====== Modal & Checkout ======
      let pmModal, invoicePrevModal, invOffcanvas, invViewModal;
      let chosenPayment = { method: 'CASH', bank: null, account: null, tx: null };
      let _checkoutSnapshot = null;

      function buildInvoicePreview() {
        const inv = _checkoutSnapshot; if (!inv) return;

        const tbody   = document.getElementById('invoice-preview-rows');
        const grossEl = document.getElementById('inv-prev-gross');
        const itemDiscEl = document.getElementById('inv-prev-itemdisc');
        const subEl   = document.getElementById('inv-prev-subtotal');
        const extraEl = document.getElementById('inv-prev-extradisc');
        const finalEl = document.getElementById('invoice-preview-final');
        const paySum  = document.getElementById('invoice-payment-summary');
        
        tbody.innerHTML = '';
        for (const it of inv.cart) {
          const qty   = Number(it.quantityInCart || 0);
          const price = Number(it.priceSell || 0);
          const gross = price * qty;
          const final = gross * (1 - Number(it.discountPercent || 0) / 100); // giảm theo dòng
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${it.name}</td>
            <td class="text-end">${qty}</td>
            <td class="text-end">${VND.format(price)}</td>
            <td class="text-end">${VND.format(final)}</td>`;
          tbody.appendChild(tr);
        }

        const tt = computeTotals(inv);
        grossEl.textContent    = VND.format(tt.gross) + ' VND';
        itemDiscEl.textContent = VND.format(tt.itemDisc) + ' VND';
        subEl.textContent      = VND.format(tt.subtotal) + ' VND';
        extraEl.textContent    = VND.format(tt.extraVat) + ' VND';
        finalEl.textContent    = VND.format(tt.finalToPay) + ' VND';

        paySum.textContent = chosenPayment.method === 'BANK'
          ? `Chuyển khoản (${chosenPayment.bank || '---'}${chosenPayment.account ? ' • ' + chosenPayment.account : ''}${chosenPayment.tx ? ' • Ref ' + chosenPayment.tx : ''})`
          : 'Tiền mặt';
      }

      // >>>>> THAY ĐỔI CHÍNH Ở ĐÂY: ép giảm vào đơn giá khi LƯU <<<<<
      function makeCheckoutPayload(inv, locationId, chosenPayment){
        const items = inv.cart.map(it => {
          const qty   = Number(it.quantityInCart || 0);
          const price = Number(it.priceSell || 0);
          const dsc   = Number(it.discountPercent || 0);
          // Đơn giá đã giảm để LƯU (không lưu discount theo dòng):
          const unitPriceAdjusted = Math.round(price * (1 - dsc/100)); // VND → làm tròn đồng
          return {
            goodID: it.goodID,
            quantity: qty,
            unitPrice: unitPriceAdjusted,
            discountPercent: 0
          };
        });

        const tt = computeTotals(inv);

        return {
          locationId: Number(locationId),
          customerId: inv?.customer?.id ?? null,
          items,
          paymentMethod: chosenPayment?.method || 'CASH',
          paymentInfo: chosenPayment || null,
          invoiceEmail: (document.getElementById('invoice-email')?.value || '').trim() || null,
          globalVatPercent: GLOBAL_VAT_PERCENT, // VAT mức hóa đơn
          totals: {
            gross: tt.gross,
            itemDiscount: tt.itemDisc,
            vatOnSubtotal: tt.extraVat,
            finalToPay: tt.finalToPay
          },
          totalAmount: tt.finalToPay
        };
      }

      async function readErrorMessage(res){
        const raw = await res.text();
        try{
          const j = raw ? JSON.parse(raw) : null;
          return (j?.message || j?.error || raw || `HTTP ${res.status}`);
        }catch{ return raw || `HTTP ${res.status}`; }
      }

      async function finalConfirmCheckout() {
        if(!_checkoutSnapshot) { alert("Không tìm thấy thông tin hóa đơn."); return; }
        const inv = _checkoutSnapshot;

        if(!inv.cart || inv.cart.length === 0){
          alert("Giỏ hàng trống."); 
          return;
        }

        let locationId = CURRENT_LOCATION_ID;
        if(locationId == null || Number.isNaN(Number(locationId)) || Number(locationId) <= 0){
          await resolveLocationIdFromStore();
          locationId = CURRENT_LOCATION_ID;
        }
        if(locationId == null || Number.isNaN(Number(locationId)) || Number(locationId) <= 0){
          alert("Không xác định được Location của Store. Vui lòng đăng nhập lại hoặc kiểm tra token/storeId.");
          return;
        }

        for(const it of inv.cart){
          const maxAvail = Number(it.quantityAvailable || 0);
          const q = Number(it.quantityInCart || 0);
          if(q <= 0){
            alert(`Số lượng của mặt hàng "${it.name}" phải > 0.`);
            return;
          }
          if(maxAvail > 0 && q > maxAvail){
            alert(`"${it.name}" chỉ còn ${maxAvail}. Hãy giảm số lượng trước khi thanh toán.`);
            return;
          }
        }

        const payload = makeCheckoutPayload(inv, locationId, chosenPayment);

        try{
          const res = await fetch(`${API_SALES}/checkout`, {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify(payload),
          });

          if (handleAuthError(res)) return;

          if(!res.ok){
            const msg = await readErrorMessage(res);
            throw new Error(msg || "Không thể thực hiện giao dịch.");
          }

          const live = getActiveInvoice();
          if (live) {
            live.cart = [];
            renderCart();
            try { localStorage.removeItem(`pos_invoice_${live.num}`); } catch {}
          }

          invoicePrevModal?.hide();
          alert("Thanh toán thành công!");

        }catch(err){
          console.error("Lỗi thanh toán (400/…):", err);
          alert('Có lỗi khi thanh toán: ' + (err?.message || err));
        }finally{
          _checkoutSnapshot = null;
        }
      }

      // ====== INVOICE EXPLORER (Offcanvas) ====== (không đổi)
      const invBtnOpen = $("#btn-open-invoices");
      const invKeyword = $("#inv-keyword");
      const invCusInput = $("#inv-cus-input");
      const invCusSuggest = $("#inv-cus-suggest");
      const invCusChosen = $("#inv-cus-chosen");
      const invCusClear  = $("#inv-cus-clear");
      const invFrom = $("#inv-from");
      const invTo   = $("#inv-to");
      const invStatus = $("#inv-status");
      const invPageSize = $("#inv-page-size");
      const invSearchBtn = $("#inv-search-btn");
      const invClearFiltersBtn = $("#inv-clear-filters");
      const invTbody = $("#inv-tbody");
      const invPrevBtn = $("#inv-prev");
      const invNextBtn = $("#inv-next");
      const invSummary = $("#inv-summary");

      const invxState = {
        page: 1, pageSize: 10, totalCount: 0,
        keyword: "", customerId: null, customerName: "",
        from: "", to: "", status: ""
      };

      invBtnOpen.addEventListener("click", () => {
        invOffcanvas?.show();
        if (!invxState._loaded) { invxState._loaded = true; invxLoad(); }
      });

      invCusInput.addEventListener("input", debounce(async (e)=>{
        const q = (e.target.value||"").trim();
        if(!q){ invCusSuggest.classList.add("d-none"); invCusSuggest.innerHTML=""; return; }
        try{
          const url = `${API_CUSTOMERS}/search?q=${encodeURIComponent(q)}`;
          const res = await fetch(url, { headers: authHeaders() });
          if (handleAuthError(res)) return;
          if(!res.ok) throw new Error(await res.text());
          const arr = await res.json();
          invCusSuggest.innerHTML = "";
          if(!Array.isArray(arr) || arr.length===0){
            invCusSuggest.classList.add("d-none"); return;
          }
          arr.forEach(c=>{
            const d=document.createElement("div");
            d.className="inv-suggest-item";
            d.innerHTML = `<div class="fw-semibold">${c.name}</div><div class="small text-muted">${c.phoneNumber || ''} ${c.email ? ' • '+c.email : ''}</div>`;
            d.addEventListener("click", ()=>{
              invxState.customerId = c.customerID;
              invxState.customerName = c.name;
              invCusInput.value = "";
              invCusSuggest.classList.add("d-none");
              invCusSuggest.innerHTML="";
              invCusChosen.innerHTML = `<span class="badge bg-success inv-customer-badge"><i class="fas fa-user me-1"></i>${c.name}${c.phoneNumber? ' • '+c.phoneNumber:''}</span>`;
            });
            invCusSuggest.appendChild(d);
          });
          invCusSuggest.classList.remove("d-none");
        }catch(err){
          invCusSuggest.classList.add("d-none"); invCusSuggest.innerHTML="";
        }
      }, 250));
      document.addEventListener("click", (e)=>{
        if(!invCusSuggest.contains(e.target) && e.target !== invCusInput){
          invCusSuggest.classList.add("d-none");
        }
      });
      invCusClear.addEventListener("click", ()=>{
        invxState.customerId = null;
        invxState.customerName = "";
        invCusChosen.innerHTML = "";
      });

      invClearFiltersBtn.addEventListener("click", ()=>{
        invKeyword.value=""; invCusInput.value="";
        invxState.customerId=null; invxState.customerName="";
        invCusChosen.innerHTML="";
        invFrom.value=""; invTo.value="";
        invStatus.value="";
        invPageSize.value="10";
        invxState.page = 1;
        invxLoad();
      });

      invSearchBtn.addEventListener("click", ()=>{
        invxState.keyword = (invKeyword.value||"").trim();
        invxState.from = invFrom.value || "";
        invxState.to   = invTo.value   || "";
        invxState.status = invStatus.value || "";
        invxState.pageSize = Number(invPageSize.value||10);
        invxState.page = 1;
        invxLoad();
      });

      invPrevBtn.addEventListener("click", ()=>{ if(invxState.page>1){ invxState.page--; invxLoad(); } });
      invNextBtn.addEventListener("click", ()=>{ invxState.page++; invxLoad(); });

      function pickAmount(x){
        const keys = [
          'finalToPay','finalAmount','totalAmount','grandTotal','amount','total',
          'payable','payableAmount','netAmount','grandTotalAmount','sumFinal','sum','final'
        ];
        for (const k of keys){
          if (x[k] != null) return num(x[k]);
          const K = k[0].toUpperCase() + k.slice(1);
          if (x[K] != null) return num(x[K]);
          const U = k.toUpperCase();
          if (x[U] != null) return num(x[U]);
        }
        const nested = x.totals || x.summary || x.total || null;
        if (nested && typeof nested === 'object'){
          for (const k of ['final','finalToPay','payable','grandTotal','total','amount']){
            if (nested[k] != null) return num(nested[k]);
            const K = k[0].toUpperCase() + k.slice(1);
            if (nested[K] != null) return num(nested[K]);
            const U = k.toUpperCase();
            if (nested[U] != null) return num(nested[U]);
          }
        }
        return 0;
      }

      // >>>>>>>>>> FE gọi API danh sách hóa đơn kèm storeId <<<<<<<<<<
      async function invxFetchInvoices(){
        const sid = getStoreId();
        if (sid == null) {
          alert("Không tìm thấy storeId. Vui lòng đăng nhập lại.");
          return { items: [], totalCount: 0 };
        }

        const qs = new URLSearchParams();
        qs.set("storeId", String(sid));
        if (invxState.keyword) qs.set("keyword", invxState.keyword);
        if (invxState.customerId) qs.set("customerId", String(invxState.customerId));
        if (invxState.from) qs.set("from", invxState.from);
        if (invxState.to) qs.set("to", invxState.to);
        if (invxState.status) qs.set("status", invxState.status);
        qs.set("page", String(invxState.page));
        qs.set("pageSize", String(invxState.pageSize));

        const url = `${API_INVOICES}?${qs.toString()}`;

        const res = await fetch(url, { headers: authHeaders() });
        if (handleAuthError(res)) return { items: [], totalCount: 0 };
        const text = await res.text();
        if(!res.ok) throw new Error(text || `HTTP ${res.status}`);
        const data = text ? JSON.parse(text) : [];

        if (Array.isArray(data)) {
          return { items: data, totalCount: (invxState.page * invxState.pageSize) + (data.length === invxState.pageSize ? invxState.pageSize : 0) };
        } else if (data && Array.isArray(data.items)) {
          return { items: data.items, totalCount: Number(data.totalCount||data.total||0) };
        } else if (data && Array.isArray(data.data)) {
          return { items: data.data, totalCount: Number(data.totalCount||data.total||0) };
        }
        return { items: [], totalCount: 0 };
      }

      // ===== render list + backfill tổng nếu thiếu =====
      function invxRenderList(items){
        const invTbody = $("#inv-tbody");
        invTbody.innerHTML = "";
        if(!Array.isArray(items) || items.length===0){
          invTbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">Không có hóa đơn.</td></tr>`;
          return;
        }

        const needsBackfill = [];

        items.forEach(x=>{
          const id = x.id ?? x.invoiceID ?? x.invoiceId ?? x.saleID ?? x.saleId ?? x.number ?? x.code;
          const code = x.code ?? x.invoiceCode ?? x.number ?? `#${id ?? '—'}`;
          const custName = x.customerName ?? x.customer?.name ?? 'Khách lẻ';
          const total = pickAmount(x);
          const status = x.status ?? x.state ?? 'Completed';
          const created = x.createdAt ?? x.saleDate ?? x.createdOn ?? x.date ?? x.issuedAt ?? x.created ?? null;
          const createdText = created ? toDateStr(created) : '—';

          const tr = document.createElement("tr");
          tr.className = "inv-row";
          tr.innerHTML = `
            <td><span class="fw-semibold">${code}</span></td>
            <td>${custName ? `<span class="badge bg-light text-dark">${custName}</span>` : ''}</td>
            <td class="text-end inv-td-total">${fmt(Number(total))} VND</td>
            <td>${createdText}</td>
            <td><span class="badge ${status==='Completed'?'bg-success': status==='Draft'?'bg-secondary':'bg-danger'} inv-status">${status}</span></td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary inv-view-btn" data-id="${id}" title="Xem chi tiết">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          `;
          invTbody.appendChild(tr);

          if (!total || total <= 0){
            needsBackfill.push({ id, cell: tr.querySelector('.inv-td-total') });
          }
        });

        $$(".inv-view-btn", invTbody).forEach(btn=>{
          btn.addEventListener("click", ()=> invxOpenDetail(btn.dataset.id));
        });

        if (needsBackfill.length){
          (async () => {
            for (const r of needsBackfill){
              try{
                const d = await invxFetchInvoiceDetail(r.id);
                if (!d || !Array.isArray(d.items)) continue;
                let gross=0, itemDisc=0;
                for (const it of d.items){
                  const g = num(it.unitPrice) * num(it.quantity);
                  const dsc = g * (Number(it.discountPercent||0)/100);
                  gross += g; itemDisc += dsc;
                }
                const subtotal = gross - itemDisc;
                const extraVat = Math.round(subtotal * (GLOBAL_VAT_PERCENT/100));
                const final    = subtotal + extraVat;
                r.cell.textContent = `${fmt(final)} VND`;
              }catch(e){
                console.warn('Backfill total failed for invoice', r.id, e);
              }
            }
          })();
        }
      }

      // >>>>>>>>>> FE gọi API chi tiết hóa đơn kèm storeId <<<<<<<<<<
      async function invxFetchInvoiceDetail(id){
        const sid = getStoreId();
        if (sid == null) { alert("Không tìm thấy storeId. Vui lòng đăng nhập lại."); return null; }
        const res = await fetch(`${API_INVOICE}/${id}?storeId=${sid}`, { headers: authHeaders() });
        if (handleAuthError(res)) return null;
        const text = await res.text();
        if(!res.ok) throw new Error(text || `HTTP ${res.status}`);
        const data = text ? JSON.parse(text) : null;

        return {
          code: data.code ?? data.invoiceCode ?? data.number ?? `#${data.id ?? ''}`,
          createdAt: data.createdAt ?? data.saleDate ?? data.createdOn ?? data.date ?? null,
          customerName: data.customerName ?? data.customer?.name ?? 'Khách lẻ',
          customerPhone: data.customer?.phoneNumber ?? data.customerPhone ?? '',
          customerEmail: data.customer?.email ?? data.customerEmail ?? '',
          status: data.status ?? data.state ?? 'Completed',
          paymentMethod: data.paymentMethod ?? data.payment?.method ?? 'CASH',
          paymentInfo: data.paymentInfo ?? data.payment ?? null,
          items: (data.items ?? data.lines ?? []).map(it=>({
            name: it.name ?? it.goodName ?? it.productName ?? `#${it.goodID ?? it.productID ?? ''}`,
            quantity: Number(it.quantity ?? it.quantitySold ?? it.qty ?? 0),
            unitPrice: Number(it.unitPrice ?? it.priceSell ?? it.price ?? 0),
            discountPercent: Number(it.discountPercent ?? it.discount ?? 0)
          }))
        };
      }

      function invxRenderDetail(d){
        const meta = $("#inv-view-meta");
        const tbody = $("#inv-view-rows");
        const totalEl = $("#inv-view-total");
        const extra = $("#inv-view-extra");

        meta.textContent = `${d.code} • ${d.createdAt? toDateStr(d.createdAt) : '—'} • ${d.status} • Thanh toán: ${d.paymentMethod}`;

        tbody.innerHTML = "";
        let gross = 0, itemDisc = 0;
        d.items.forEach(it=>{
          const lineGross = it.quantity * it.unitPrice;
          const lineDisc  = lineGross * (Number(it.discountPercent||0)/100);
          const lineFinal = lineGross - lineDisc;
          gross += lineGross;
          itemDisc += lineDisc;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${it.name}</td>
            <td class="text-end">${fmt(it.quantity)}</td>
            <td class="text-end">${fmt(it.unitPrice)} VND</td>
            <td class="text-end">${fmt(lineFinal)} VND</td>
          `;
          tbody.appendChild(tr);
        });
        const subtotal = gross;
        const extraVat = Math.round(subtotal * GLOBAL_VAT_PERCENT / 100);
        const final = subtotal + extraVat;

        document.getElementById('inv-view-gross').textContent     = `${fmt(gross)} VND`;
        // document.getElementById('inv-view-itemdisc').textContent  = `${fmt(itemDisc)} VND`;
        // document.getElementById('inv-view-subtotal').textContent  = `${fmt(subtotal)} VND`;
        document.getElementById('inv-view-extradisc').textContent = `${fmt(extraVat)} VND`;
        totalEl.textContent = `${fmt(final)} VND`;

        extra.innerHTML = `
          <div>Khách hàng: <strong>${d.customerName}</strong> ${d.customerPhone? ' • '+d.customerPhone:''} ${d.customerEmail? ' • '+d.customerEmail:''}</div>
          <div class="text-muted">Phương thức: ${d.paymentMethod}${d.paymentInfo?.bank? ' • '+d.paymentInfo.bank:''}${d.paymentInfo?.account? ' • '+d.paymentInfo.account:''}${d.paymentInfo?.tx? ' • Ref '+d.paymentInfo.tx:''}</div>
        `;
      }

      async function invxOpenDetail(id){
        try{
          const d = await invxFetchInvoiceDetail(id);
          if(!d){ alert("Không đọc được chi tiết hóa đơn."); return; }
          invxRenderDetail(d);
          invViewModal?.show();
        }catch(err){
          alert("Không đọc được chi tiết hóa đơn: " + (err?.message || err));
        }
      }

      async function invxLoad(){
        try{
          const { items, totalCount } = await invxFetchInvoices();
          invxState.totalCount = Number(totalCount||0);
          invxRenderList(items);

          const start = (invxState.page-1)*invxState.pageSize + 1;
          const end = start + (items?.length||0) - 1;
          invSummary.textContent = (items?.length||0) ? `Hiển thị ${start}–${end}${invxState.totalCount? ' / '+invxState.totalCount : ''}` : 'Không có kết quả';
          invPrevBtn.disabled = invxState.page<=1;
          invNextBtn.disabled = (items?.length||0) < invxState.pageSize && !!invxState.totalCount && end>=invxState.totalCount;
        }catch(err){
          const invTbody = $("#inv-tbody");
          invTbody.innerHTML = `<tr><td colspan="6" class="text-danger">Lỗi tải danh sách: ${err?.message || err}</td></tr>`;
          invSummary.textContent = '—';
        }
      }

      // ====== Events & init ======
      const hideIfEmpty = ()=>{ if (!productSearchInput.value.trim()) searchResultsDiv.classList.add("d-none"); };
      productSearchInput.addEventListener("input", debounce(e=> { searchProducts(e.target.value); if (!e.target.value) hideIfEmpty(); }, 250));
      productSearchInput.addEventListener("keydown", e=>{
        if(e.key==="Enter"){
          const first = document.querySelector(".search-results-item");
          if(first){ first.click(); e.preventDefault(); }
        }
      });
      document.addEventListener("click", e=>{
        const box = document.getElementById("search-results");
        const input = document.getElementById("product-search-input");
        if(box && input && !input.contains(e.target) && !box.contains(e.target)){
          box.classList.add("d-none");
        }
      });

      // Customer search (POS khu trái)
      customerSearchInput.addEventListener('input', debounce(e=>{
        const q = e.target.value;
        if(q && q.trim().length >= 1) searchCustomers(q);
        else { customerSuggestDiv.classList.add('d-none'); customerSuggestDiv.innerHTML=''; }
      }, 250));
      document.addEventListener('click', (e)=>{
        if(!customerSuggestDiv.contains(e.target) && e.target !== customerSearchInput){
          customerSuggestDiv.classList.add('d-none');
        }
      });

      btnClearInvoice.addEventListener("click", ()=>{
        const inv=getActiveInvoice(); if(!inv) return;
        if(inv.cart.length===0) return;
        if(confirm("Xóa toàn bộ giỏ hàng hiện tại?")){ inv.cart=[]; renderCart(); }
      });
      btnHoldInvoice.addEventListener("click", ()=>{
        const inv = getActiveInvoice();
        if(inv) {
          try { localStorage.setItem(`pos_invoice_${inv.num}`, JSON.stringify(inv)); } catch {}
          alert(`Đã lưu trạng thái ${inv.name} vào bộ nhớ cục bộ.`);
        }
      });

      document.addEventListener("keydown", e=>{
        if(e.ctrlKey && e.key.toLowerCase()==="n"){ e.preventDefault(); createInvoice(); }
        if(e.key==="Delete"){
          const active = document.activeElement;
          const wrapper = active?.closest?.(".cart-item");
          if(wrapper){
            const id = Number(wrapper.dataset.goodId);
            removeById(id);
          }
        }
      });

      // Init modals & offcanvas
      document.addEventListener('DOMContentLoaded', () => {
        pmModal = new bootstrap.Modal(document.getElementById('paymentMethodModal'));
        invoicePrevModal = new bootstrap.Modal(document.getElementById('invoicePreviewModal'));
        addCustomerModal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
        invOffcanvas = new bootstrap.Offcanvas(document.getElementById('inv-offcanvas'));
        invViewModal = new bootstrap.Modal(document.getElementById('invoiceViewModal'));

        document.getElementById('paymentMethodModal').addEventListener('change', (e) => {
          if (e.target && e.target.name === 'pmethod') {
            const v = e.target.value;
            const area = document.getElementById('pm-bank-area');
            if (area) area.classList.toggle('d-none', v !== 'BANK');
            chosenPayment.method = v;
          }
        });

        document.getElementById('pm-next').addEventListener('click', () => {
          if (chosenPayment.method === 'BANK') {
            chosenPayment.bank = (document.getElementById('pm-bank')?.value) || null;
            chosenPayment.account = (document.getElementById('pm-account')?.value || '').trim() || null;
            chosenPayment.tx = (document.getElementById('pm-tx')?.value || '').trim() || null;
          } else {
            chosenPayment.bank = chosenPayment.account = chosenPayment.tx = null;
          }
          document.activeElement?.blur();

          pmModal?.hide();
          buildInvoicePreview();

          setTimeout(() => invoicePrevModal?.show(), 120);
        });

        document.getElementById('btn-confirm-checkout').addEventListener('click', finalConfirmCheckout);

        checkoutButton.addEventListener('click', (e) => {
          e.preventDefault();
          const inv = getActiveInvoice();
          if(!inv || inv.cart.length===0){ alert("Giỏ hàng trống."); return; }
          _checkoutSnapshot = cloneDeep(inv);
          _checkoutSnapshot.locationId = CURRENT_LOCATION_ID;
          pmModal?.show();
        });
      });

      (async () => {
        await resolveLocationIdFromStore();  
        createInvoice();
      })();
    </script>
  </body>
</html>
