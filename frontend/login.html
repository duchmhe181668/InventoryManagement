<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Đăng nhập - InventoryManagement</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{min-height:100vh;background:#f5f7fb;display:flex;align-items:center;justify-content:center}
    .card{width:100%;max-width:420px;border:none;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .brand{font-weight:700;letter-spacing:.5px}
    .form-control:focus{box-shadow:none;border-color:#0d6efd}
    .spinner{display:none}
    .toggle-pw{cursor:pointer}
  </style>
</head>
<body>
  <div class="card p-4">
    <div class="mb-3 text-center">
      <div class="brand fs-4">InventoryManagement</div>
      <div class="text-muted">Đăng nhập hệ thống</div>
    </div>

    <div id="alert" class="alert d-none" role="alert"></div>

    <form id="loginForm" novalidate>
      <div class="mb-3">
        <label class="form-label">Username</label>
        <input id="username" class="form-control" autocomplete="username" required />
        <div class="invalid-feedback">Nhập username</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Mật khẩu</label>
        <div class="input-group">
          <input id="password" type="password" class="form-control" autocomplete="current-password" required />
          <span class="input-group-text toggle-pw" title="Hiện/ẩn mật khẩu">👁️</span>
          <div class="invalid-feedback">Nhập mật khẩu</div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check">
          <input id="remember" class="form-check-input" type="checkbox">
          <label class="form-check-label" for="remember">Ghi nhớ</label>
        </div>
        <a class="small text-decoration-none" href="#" onclick="alert('Liên hệ quản trị để đặt lại mật khẩu');return false;">Quên mật khẩu?</a>
      </div>

      <button id="btnLogin" type="submit" class="btn btn-primary w-100">
        <span class="spinner-border spinner-border-sm me-2 spinner" role="status" aria-hidden="true"></span>
        Đăng nhập
      </button>
    </form>
  </div>

<script>
(function () {
  const API_URL = 'https://localhost:7225/api/Auth/login'; // API của bạn

  const form = document.getElementById('loginForm');
  const alertBox = document.getElementById('alert');
  const spinnerEls = document.getElementsByClassName('spinner');
  const btnLogin = document.getElementById('btnLogin');
  const toggle = document.querySelector('.toggle-pw');
  const pwd = document.getElementById('password');

  toggle.addEventListener('click', () => {
    pwd.type = (pwd.type === 'password') ? 'text' : 'password';
  });

  function showAlert(msg, type='danger') {
    alertBox.textContent = msg;
    alertBox.className = 'alert alert-' + type;
  }
  function clearAlert() {
    alertBox.className = 'alert d-none';
    alertBox.textContent = '';
  }
  function setLoading(b) {
    [...spinnerEls].forEach(s => s.style.display = b ? 'inline-block' : 'none');
    btnLogin.disabled = b;
  }

  async function login(username, password) {
    const res = await fetch(API_URL, {
      method: 'POST',
      mode: 'cors',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ username, password })
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      const msg = typeof data === 'string' ? data : (data?.title || data?.message || 'Đăng nhập thất bại');
      throw new Error(msg);
    }
    // Kỳ vọng: { accessToken, tokenType, expiresInSeconds, username, role, supplierId, storeId }
    return data;
  }

  function persistAuth(result, remember) {
    const store = remember ? localStorage : sessionStorage;

    // Lưu đầy đủ payload để các trang khác dùng
    try { store.setItem('authUser', JSON.stringify(result)); } catch {}

    // Các key lẻ (tương thích code cũ)
    try { store.setItem('accessToken', result.accessToken || ''); } catch {}
    try { store.setItem('tokenType', result.tokenType || 'Bearer'); } catch {}
    if (result.storeId !== undefined && result.storeId !== null) {
      try { store.setItem('storeId', String(result.storeId)); } catch {}
    }
    if (result.supplierId !== undefined && result.supplierId !== null) {
      try { store.setItem('supplierId', String(result.supplierId)); } catch {}
    }
    // Có thể lưu thời điểm hết hạn để auto logout (tuỳ bạn):
    if (typeof result.expiresInSeconds === 'number') {
      const expireAt = Date.now() + (result.expiresInSeconds * 1000);
      try { store.setItem('tokenExpireAt', String(expireAt)); } catch {}
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearAlert();

    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      return;
    }

    setLoading(true);
    const username = document.getElementById('username').value.trim();
    const password = pwd.value;
    const remember = document.getElementById('remember').checked;

    try {
      const result = await login(username, password);

      persistAuth(result, remember);

      showAlert(`✅ Đăng nhập thành công! Xin chào ${result.username}.`, 'success');

      const role = (result.role || '').toString();
      let target = '/';
      if (role === 'Supplier') {
        target = '/supplier.html';
      } else if (role === 'StoreManager' || role === 'Administrator' || role === 'WarehouseManager') {
        target = '/home.html';
      }
      setTimeout(() => { window.location.href = target; }, 400);

    } catch (err) {
      showAlert((err && err.message) ? err.message : 'Đăng nhập thất bại', 'danger');
    } finally {
      setLoading(false);
    }
  });
})();
</script>
</body>
</html>
