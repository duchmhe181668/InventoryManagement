<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÄÄƒng nháº­p - InventoryManagement</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{min-height:100vh;background:#f5f7fb;display:flex;align-items:center;justify-content:center}
    .card{width:100%;max-width:420px;border:none;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .brand{font-weight:700;letter-spacing:.5px}
    .form-control:focus{box-shadow:none;border-color:#0d6efd}
    .spinner{display:none}
    .toggle-pw{cursor:pointer}
  </style>
</head>
<body>
  <div class="card p-4">
    <div class="mb-3 text-center">
      <div class="brand fs-4">InventoryManagement</div>
      <div class="text-muted">ÄÄƒng nháº­p há»‡ thá»‘ng</div>
    </div>

    <div id="alert" class="alert d-none" role="alert"></div>

    <form id="loginForm" novalidate>
      <div class="mb-3">
        <label class="form-label">Username</label>
        <input id="username" class="form-control" autocomplete="username" required />
        <div class="invalid-feedback">Nháº­p username</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Máº­t kháº©u</label>
        <div class="input-group">
          <input id="password" type="password" class="form-control" autocomplete="current-password" required />
          <span class="input-group-text toggle-pw" title="Hiá»‡n/áº©n máº­t kháº©u">ğŸ‘ï¸</span>
          <div class="invalid-feedback">Nháº­p máº­t kháº©u</div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check">
          <input id="remember" class="form-check-input" type="checkbox">
          <label class="form-check-label" for="remember">Ghi nhá»›</label>
        </div>
        <a class="small text-decoration-none" href="#" onclick="alert('LiÃªn há»‡ quáº£n trá»‹ Ä‘á»ƒ Ä‘áº·t láº¡i máº­t kháº©u');return false;">QuÃªn máº­t kháº©u?</a>
      </div>

      <button id="btnLogin" type="submit" class="btn btn-primary w-100">
        <span class="spinner-border spinner-border-sm me-2 spinner" role="status" aria-hidden="true"></span>
        ÄÄƒng nháº­p
      </button>
    </form>
  </div>

<script>
(function () {
  const API_URL = 'https://localhost:7225/api/Auth/login'; // <- API cá»§a báº¡n

  const form = document.getElementById('loginForm');
  const alertBox = document.getElementById('alert');
  const spinnerEls = document.getElementsByClassName('spinner');
  const btnLogin = document.getElementById('btnLogin');
  const toggle = document.querySelector('.toggle-pw');
  const pwd = document.getElementById('password');

  toggle.addEventListener('click', () => {
    pwd.type = (pwd.type === 'password') ? 'text' : 'password';
  });

  function showAlert(msg, type='danger') {
    alertBox.textContent = msg;
    alertBox.className = 'alert alert-' + type;
  }
  function clearAlert() {
    alertBox.className = 'alert d-none';
    alertBox.textContent = '';
  }
  function setLoading(b) {
    [...spinnerEls].forEach(s => s.style.display = b ? 'inline-block' : 'none');
    btnLogin.disabled = b;
  }

  async function login(username, password) {
    const res = await fetch(API_URL, {
      method: 'POST',
      mode: 'cors', // cáº§n náº¿u gá»i khÃ¡c origin
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ username, password })
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      throw new Error(typeof data === 'string' ? data : (data?.title || data?.message || 'ÄÄƒng nháº­p tháº¥t báº¡i'));
    }
    return data; // { accessToken, tokenType, expiresInSeconds, username }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearAlert();

    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      return;
    }

    setLoading(true);
    const username = document.getElementById('username').value.trim();
    const password = pwd.value;

    try {
      const result = await login(username, password);

      // Tuá»³ chá»n: lÆ°u token náº¿u cáº§n dÃ¹ng tiáº¿p (cÃ³ thá»ƒ bá» náº¿u khÃ´ng cáº§n)
      const store = document.getElementById('remember').checked ? localStorage : sessionStorage;
      store.setItem('authToken', result.accessToken);
      store.setItem('authUser', result.username);
      store.setItem('supplierId', result.supplierId);


      showAlert(`âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng! Xin chÃ o ${result.username}.`, 'success');
      // ---- Redirect theo role ----
      // const role = (result.role || '').toLowerCase();
      // !!!
      const role = (result.role || '');

      let target = '/'; // trang máº·c Ä‘á»‹nh
      console.log(role);
      if (role === 'Supplier') {
        target = '/supplier.html';
      } else if (role === 'StoreManager' || role === 'Administrator' || role === "WarehouseManager") {
        target = '/home.html';
      } 
      setTimeout(() => { window.location.href = target; }, 500);
      // ----------------------------
   
    } catch (err) {
      showAlert((err && err.message) ? err.message : 'ÄÄƒng nháº­p tháº¥t báº¡i', 'danger');
    } finally {
      setLoading(false);
    }
  });
})();
</script>
</body>
</html>