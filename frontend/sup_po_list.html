<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>Supplier — Purchase Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #0d6efd;
      --text: #111111;
      --bg: #ffffff;
      --muted: #6b7280;
      --border: #e5e7eb;
    }

    html,
    body {
      height: 100%;
    }

    body {
      padding: 20px;
      background: var(--bg);
      color: var(--text);
    }

    /* Sidebar full-height + sticky */
    .layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    #sidebar {
      position: sticky;
      top: 20px;
      min-height: calc(100vh - 40px);
      width: 260px;
      background: var(--primary);
      color: #fff;
      border-radius: 10px;
      border: none;
      display: flex;
      flex-direction: column;
      padding: 16px;
    }

    #sidebar h5 {
      color: #fff;
    }

    #sidebar .nav-link {
      color: rgba(255, 255, 255, .92);
      padding-left: 0;
    }

    #sidebar .nav-link:hover {
      color: #fff;
      text-decoration: underline;
    }

    #sidebar .nav-link.active {
      color: #fff;
      font-weight: 600;
    }

    #msg {
      color: #e0e7ff;
    }

    main.flex-grow-1 {
      flex: 1;
    }

    .muted {
      color: var(--muted);
    }

    .error {
      color: #b91c1c;
    }

    .ok {
      color: #065f46;
    }

    tr.clickable:hover {
      background: #f8fafc;
      cursor: pointer;
    }

    .table-narrow th,
    .table-narrow td {
      padding: .4rem .6rem;
      border-color: var(--border);
    }

    .detail-cell {
      padding: 0 !important;
      background: #fafafa;
    }

    .slide {
      overflow: hidden;
      max-height: 0;
      transition: max-height 280ms ease;
      border-top: 1px solid var(--border);
    }

    .slide-inner {
      padding: 12px 16px;
    }

    .btn-primary,
    .btn-outline-primary:hover {
      background-color: var(--primary) !important;
      border-color: var(--primary) !important;
    }

    .btn-outline-primary {
      color: var(--primary);
      border-color: var(--primary);
    }

    .form-select-sm {
      border-color: var(--border);
    }
  </style>
</head>

<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside id="sidebar">
      <div>
        <h5 class="mb-3">Menu</h5>
        <ul class="nav flex-column">
          <li class="nav-item"><a href="index.html" class="nav-link">Trang chủ</a></li>
          <li class="nav-item"><a href="sup_po_list.html" class="nav-link active">Đơn hàng</a></li>
          <li class="nav-item"><a href="sup_receipt_list.html" class="nav-link">Biên lai</a></li>
        </ul>
      </div>
      <div class="mt-3 small" id="msg"></div>
    </aside>

    <main class="flex-grow-1">
      <div class="d-flex align-items-center gap-2">
        <h2 class="m-0">Danh sách đơn hàng</h2>
        <div class="ms-auto d-flex align-items-center gap-2">
          <label class="form-label m-0">Trạng thái</label>
          <select id="status" class="form-select form-select-sm" style="width:180px">
            <option value="" selected>Tất cả</option>
            <option value="Submitted">Đã gửi</option>
            <option value="Received">Đã nhận</option>
            <option value="Shipping">Đang giao</option>
            <option value="Done">Xong</option>
            <option value="Cancelled">Hủy</option>
          </select>

          <button id="btnReload" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i> Làm mới
          </button>
        </div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-bordered table-hover table-narrow">
          <thead class="table-light">
            <tr>
              <th>POID</th>
              <th>Tên nhà cung cấp</th>
              <th>Ngày tạo</th>
              <th>Trạng thái</th>
              <th>Số lượng dòng</th>
              <th>Tổng tiền</th>
              <th style="width:260px">Actions</th>
            </tr>
          </thead>
          <tbody id="poTableBody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    // ==== Cấu hình & state ====
    const API_BASE = "https://localhost:7225";
    const token = sessionStorage.getItem("accessToken") || localStorage.getItem("accessToken");
    const supplierId = sessionStorage.getItem("supplierId") || localStorage.getItem("supplierId");

    let currentOpenRowId = null;
    let currentDetailTr = null;

    function authHeaders() {
      return { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
    }
    function setMsg(text, type = "muted") {
      const el = document.getElementById("msg");
      if (!el) return;
      el.className = type;
      el.textContent = text || "";
    }

    // ==== Load danh sách PO theo supplier ====
    async function loadPOs() {
      if (!token || !supplierId) { location.href = "login.html"; return; }

      setMsg("Đang tải danh sách...");
      try {
        const status = document.getElementById("status").value;
        const url = new URL(`${API_BASE}/api/PurchaseOrders/by-supplier/${supplierId}`);
        url.searchParams.set("page", "1");
        url.searchParams.set("pageSize", "50");
        if (status) url.searchParams.set("status", status);

        const res = await fetch(url, { headers: authHeaders() });
        if (res.status === 204) {
          document.getElementById("poTableBody").innerHTML =
            `<tr><td colspan="7" class="text-center muted">Không có đơn hàng nào</td></tr>`;
          setMsg("Không có dữ liệu.");
          return;
        }
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);

        const data = await res.json();
        renderTable(data);
        setMsg(`Đã tải ${data.length} đơn.`, "ok");
      } catch (e) {
        console.error(e);
        setMsg("Không thể tải danh sách đơn hàng.", "error");
      }
    }

    // ==== Confirm đơn (chỉ cho Draft) ====
    async function confirmOrder(poid) {
      const yes = window.confirm(`Xác nhận đơn #${poid}?`);
      if (!yes) return;

      try {
        const res = await fetch(`${API_BASE}/api/PurchaseOrders/${poid}/confirm`, {
          method: "POST",
          headers: authHeaders()
        });
        if (!res.ok) {
          const txt = await res.text();
          alert(`Không thể confirm đơn: ${res.status} ${txt}`);
          return;
        }
        // OK -> reload list
        await loadPOs();
        setMsg(`Đơn #${poid} đã được Confirmed.`, "ok");
      } catch (e) {
        console.error(e);
        alert("Lỗi kết nối khi confirm đơn.");
      }
    }

    // ==== Render bảng + gắn click mở/đóng chi tiết ngay dưới hàng ====
function renderTable(list) {
  const tbody = document.getElementById("poTableBody");
  tbody.innerHTML = "";
  currentOpenRowId = null;
  currentDetailTr = null;

  list.forEach(po => {
    const poid = po.poid ?? po.purchaseOrderID ?? po.id;
    const supplierName = po.supplierName ?? "";
    const createdAt = po.createdAt ? new Date(po.createdAt).toLocaleString() : "";
    const status = po.status ?? "";
    const totalLines = po.totalLines ?? (po.lines ? po.lines.length : "");
    const totalAmount = po.totalAmount != null ? Number(po.totalAmount).toLocaleString() : "";

    let actionHtml = "";

    if (status === "Submitted") {
      // Khi là Submitted => hiển thị nút Nhận đơn
      actionHtml = `
        <button class="btn btn-sm btn-outline-success" 
          onclick="event.stopPropagation(); confirmReceive(${poid});">
          <i class="bi bi-box-seam"></i> Nhận đơn
        </button>`;
    } else if (status === "Received") {
      // Khi là Received => hiển thị nút Tạo biên lai
      actionHtml = `
        <a href="sup_create_receipt.html?poid=${poid}" 
           class="btn btn-sm btn-success"
           onclick="event.stopPropagation();">
           <i class="bi bi-receipt"></i> Tạo biên lai
        </a>`;
    }

    const tr = document.createElement("tr");
    tr.className = "clickable";
    tr.dataset.id = String(poid);

    tr.innerHTML = `
      <td>${poid}</td>
      <td>${supplierName}</td>
      <td>${createdAt}</td>
      <td>${status}</td>
      <td>${totalLines}</td>
      <td>${totalAmount}</td>
      <td>${actionHtml}</td>
    `;

    tr.addEventListener("click", async () => {
      if (currentOpenRowId === tr.dataset.id) {
        await closeCurrentDetail();
        return;
      }
      await closeCurrentDetail();
      await openDetailBelow(tbody, tr, poid);
    });

    tbody.appendChild(tr);
  });
}


    // ==== Mở detail ngay dưới hàng đã click ====
    async function openDetailBelow(tbody, anchorTr, poid) {
      const detailTr = document.createElement("tr");
      detailTr.className = "detail-row";
      const td = document.createElement("td");
      td.colSpan = 7;
      td.className = "detail-cell";
      td.innerHTML = `
        <div class="slide">
          <div class="slide-inner" id="detail-${poid}">
            <div class="muted">Đang tải chi tiết đơn #${poid}...</div>
          </div>
        </div>
      `;
      detailTr.appendChild(td);
      anchorTr.insertAdjacentElement("afterend", detailTr);

      try {
        const res = await fetch(`${API_BASE}/api/PurchaseOrders/${poid}`, { headers: authHeaders() });
        const box = document.getElementById(`detail-${poid}`);

        if (res.status === 404) { box.innerHTML = `<p class="error">404: Không tìm thấy đơn.</p>`; }
        else if (res.status === 403) { box.innerHTML = `<p class="error">403: Đơn không thuộc Supplier hiện tại.</p>`; }
        else if (res.status === 409) {
          const txt = await res.text();
          box.innerHTML = `<p class="error">409: ${txt}</p>`;
        }
        else if (!res.ok) {
          box.innerHTML = `<p class="error">Lỗi: ${res.status} ${res.statusText}</p>`;
        }
        else {
          const po = await res.json();
          box.innerHTML = renderDetailHtml(po);
        }
      } catch {
        const box = document.getElementById(`detail-${poid}`);
        if (box) box.innerHTML = `<p class="error">Không thể tải chi tiết.</p>`;
      }

      const slide = detailTr.querySelector(".slide");
      requestAnimationFrame(() => { slide.style.maxHeight = slide.scrollHeight + "px"; });

      currentOpenRowId = String(poid);
      currentDetailTr = detailTr;

      detailTr.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    // ==== Đóng detail hiện tại (nếu có) ====
    function closeCurrentDetail() {
      return new Promise(resolve => {
        if (!currentDetailTr) return resolve();
        const slide = currentDetailTr.querySelector(".slide");
        slide.addEventListener("transitionend", () => {
          currentDetailTr?.remove();
          currentDetailTr = null;
          currentOpenRowId = null;
          resolve();
        }, { once: true });
        slide.style.maxHeight = "0px";
      });
    }

    // ==== HTML chi tiết đơn ====
    function renderDetailHtml(po) {
      const lines = (po.lines ?? []).map(l => `
        <tr>
          <td>${l.goodID}</td>
          <td>${l.goodName ?? ""}</td>
          <td>${l.sku ?? ""}</td>
          <td>${l.quantity}</td>
          <td class="text-end">${l.unitPrice}</td>
        </tr>
      `).join("");

      return `
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div>
            <span class="muted">Note: ${po.note ?? ""}</span>
          </div>
        </div>
        <div class="mt-2">
          <table class="table table-bordered table-sm">
            <thead class="table-light">
              <tr>
                <th>ID Sản phẩm</th><th>Tên sản phẩm</th><th>SKU</th><th>Số lượng</th><th>Đơn giá</th>
              </tr>
            </thead>
            <tbody>
              ${lines || `<tr><td colspan="5" class="text-center muted">Không có dòng</td></tr>`}
            </tbody>
          </table>
        </div>
      `;
    }

    // ==== Init ====
    document.getElementById("btnReload").addEventListener("click", loadPOs);
    document.getElementById("status").addEventListener("change", loadPOs);
    loadPOs();

    // ==== Xác nhận nhận đơn (Submitted -> Received) ====
async function confirmReceive(poid) {
  const yes = window.confirm(`Bạn có chắc chắn muốn nhận đơn #${poid} không?`);
  if (!yes) return;

  try {
    const res = await fetch(`${API_BASE}/api/PurchaseOrders/${poid}/status`, {
      method: "PATCH",
      headers: authHeaders(),
      body: JSON.stringify({ status: "Received" })
    });

    if (!res.ok) {
      const txt = await res.text();
      alert(`Cập nhật thất bại: ${txt}`);
      return;
    }

    await loadPOs();
    setMsg(`Đơn #${poid} đã được cập nhật sang "Received".`, "ok");
  } catch (e) {
    console.error(e);
    alert("Lỗi kết nối khi cập nhật trạng thái.");
  }
}



    // Gắn vào window để dùng trong onclick HTML
    window.confirmOrder = confirmOrder;
  </script>
</body>

</html>