<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Danh s√°ch Phi·∫øu tr·∫£ h√†ng - Warehouse</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="css/style.css" rel="stylesheet">
</head>

<body class="bg-light">
  <div id="sidebar"></div>
  <div class="container py-4">
    <h3 class="mb-3">‚Ü©Ô∏è Danh s√°ch Phi·∫øu tr·∫£ h√†ng</h3>

    <!-- B·ªô l·ªçc -->
    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-2">
          <label class="form-label">M√£ POID</label>
          <input type="number" class="form-control" id="poid" min="1" placeholder="Nh·∫≠p POID">
        </div>
        <div class="col-md-3">
          <label class="form-label">T√™n nh√† cung c·∫•p</label>
          <input type="text" id="supplierName" class="form-control" placeholder="Nh·∫≠p t√™n NCC">
        </div>
        <div class="col-md-2">
          <label class="form-label">T·ª´ ng√†y</label>
          <input type="date" class="form-control" id="fromDate">
        </div>
        <div class="col-md-2">
          <label class="form-label">ƒê·∫øn ng√†y</label>
          <input type="date" class="form-control" id="toDate">
        </div>
        <div class="col-md-2">
          <label class="form-label">Tr·∫°ng th√°i</label>
          <select class="form-select" id="status">
            <option value="">T·∫•t c·∫£</option>
            <option value="Submitted">ƒê√£ g·ª≠i</option>
            <option value="Confirmed">ƒê√£ x√°c nh·∫≠n</option>
          </select>
        </div>
        <div class="col-md-1 text-end">
          <button class="btn btn-primary w-100" onclick="loadReturns()">üîç</button>
        </div>
      </div>
    </div>

    <!-- N√∫t t·∫°o phi·∫øu m·ªõi -->
    <div class="mb-3 text-end">
      <a href="warehouse_receipts.html" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> T·∫°o phi·∫øu m·ªõi
      </a>
      <a href="purchase_order_list/purchase_order_list.html" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Danh s√°ch ƒë∆°n
      </a>
    </div>

    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>M√£ bi√™n lai</th>
            <th>Ng√†y t·∫°o</th>
            <th>Ng√†y nh·∫≠n</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Ghi ch√∫</th>
            <th>Ng∆∞·ªùi t·∫°o</th>
            <th class="text-center">Chi ti·∫øt</th>
          </tr>
        </thead>
        <tbody id="tblReturns"></tbody>
      </table>
    </div>

    <p id="msg" class="text-muted mt-2"></p>

    <!-- Ph√¢n trang -->
    <div id="pagination" class="mt-3 mb-4 d-flex justify-content-end"></div>
  </div>

  <!-- Modal xem chi ti·∫øt -->
  <div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Chi ti·∫øt phi·∫øu tr·∫£ h√†ng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <strong>ID phi·∫øu:</strong> <span id="modalReturnId" class="text-primary"></span><br>
            <strong>M√£ bi√™n lai:</strong> <span id="modalReceiptId" class="text-primary"></span><br>
            <strong>Tr·∫°ng th√°i:</strong> <span id="modalStatus" class="text-primary"></span><br>
            <strong>Ng√†y t·∫°o:</strong> <span id="modalCreatedAt" class="text-primary"></span>
          </div>
          <table class="table table-bordered table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>M√£ h√†ng</th><th>T√™n h√†ng</th><th>T√™n l√¥</th>
                <th class="text-end">S·ªë l∆∞·ª£ng tr·∫£</th><th>L√Ω do</th>
              </tr>
            </thead>
            <tbody id="modalReturnLines"></tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== SCRIPT ===== -->
  <script>
    const API_BASE = "https://localhost:7225";

    // ‚úÖ L·∫•y th√¥ng tin ƒëƒÉng nh·∫≠p t·ª´ storage
    const token = sessionStorage.getItem("accessToken") || localStorage.getItem("accessToken");
    const userId = sessionStorage.getItem("userId") || localStorage.getItem("userId");
    const role = (sessionStorage.getItem("authRole") || localStorage.getItem("authRole") || "").toLowerCase();

    // üßæ In ra console ƒë·ªÉ debug
    console.group("üîç Auth Info");
    console.log("Token:", token ? "(ƒë√£ c√≥)" : "‚ùå ch∆∞a c√≥");
    console.log("UserID:", userId);
    console.log("Role:", role);
    console.groupEnd();

    // üö´ Ki·ªÉm tra quy·ªÅn truy c·∫≠p
    if (!token || role !== "warehousemanager") {
      alert(`üö´ B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p (Role: ${role || "Kh√¥ng x√°c ƒë·ªãnh"})`);
      window.location.href = "login.html";
    } else {
      console.log("‚úÖ Truy c·∫≠p h·ª£p l·ªá, role:", role);
    }

    let returnsData = [];
    let currentPage = 1;
    const pageSize = 8;

    function authHeaders() {
      return { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
    }

    function setMsg(t, cls = "text-muted") {
      const m = document.getElementById("msg");
      m.className = cls;
      m.textContent = t || "";
    }

    // üì¶ Load danh s√°ch phi·∫øu tr·∫£ h√†ng
    async function loadReturns() {
      const poid = document.getElementById("poid").value;
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      const status = document.getElementById("status").value;
      const supplierName = document.getElementById("supplierName").value;

      const params = new URLSearchParams();
      if (poid) params.append("poid", poid);
      if (from) params.append("from", from);
      if (to) params.append("to", to);
      if (status) params.append("status", status);
      if (supplierName) params.append("supplierName", supplierName);

      // setMsg("ƒêang t·∫£i d·ªØ li·ªáu...");
      try {
        const url = `${API_BASE}/api/ReturnOrders/by-warehouse/${userId}?${params.toString()}`;
        console.log("üåê Fetch:", url);

        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());

        const data = await res.json();
        console.log("üì¶ D·ªØ li·ªáu phi·∫øu tr·∫£:", data);

        returnsData = data;
        currentPage = 1;
        renderTable();
        renderPagination();
        // setMsg(`ƒê√£ t·∫£i ${data.length} phi·∫øu tr·∫£ h√†ng.`, "text-success");
      } catch (e) {
        console.error("‚ùå L·ªói t·∫£i d·ªØ li·ªáu:", e);
        // setMsg("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu: " + e.message, "text-danger");
        document.getElementById("tblReturns").innerHTML =
          `<tr><td colspan="9" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
      }
    }

    // üßæ Render b·∫£ng danh s√°ch
    function renderTable() {
      const tbody = document.getElementById("tblReturns");
      if (!returnsData?.length) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
        return;
      }

      const start = (currentPage - 1) * pageSize;
      const items = returnsData.slice(start, start + pageSize);

      tbody.innerHTML = items.map(r => `
        <tr>
          <td>${r.returnID}</td>
          <td>${r.receiptID ?? "‚Äî"}</td>
          <td>${r.createdAt ? new Date(r.createdAt).toLocaleString("vi-VN") : ""}</td>
          <td>${r.confirmedAt ? new Date(r.confirmedAt).toLocaleString("vi-VN") : "‚Äî"}</td>
          <td>${r.status ?? ""}</td>
          <td>${r.note ?? ""}</td>
          <td>${r.createdBy ?? ""}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-primary" onclick="viewDetail(${r.returnID})">
              <i class="bi bi-eye"></i> Xem
            </button>
          </td>
        </tr>
      `).join("");
    }

    // üî¢ Ph√¢n trang
    function renderPagination() {
      const totalPages = Math.ceil(returnsData.length / pageSize);
      const div = document.getElementById("pagination");
      if (totalPages <= 1) { div.innerHTML = ""; return; }

      let html = `<nav><ul class="pagination">`;
      html += `<li class="page-item ${currentPage === 1 ? "disabled" : ""}">
                 <button class="page-link" onclick="changePage(${currentPage - 1})">¬´</button></li>`;
      for (let i = 1; i <= totalPages; i++) {
        html += `<li class="page-item ${i === currentPage ? "active" : ""}">
                   <button class="page-link" onclick="changePage(${i})">${i}</button></li>`;
      }
      html += `<li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
                 <button class="page-link" onclick="changePage(${currentPage + 1})">¬ª</button></li>`;
      html += `</ul></nav>`;
      div.innerHTML = html;
    }

    function changePage(p) {
      const totalPages = Math.ceil(returnsData.length / pageSize);
      if (p < 1 || p > totalPages) return;
      currentPage = p;
      renderTable();
      renderPagination();
    }

    // üîç Xem chi ti·∫øt phi·∫øu tr·∫£
    async function viewDetail(id) {
      try {
        const res = await fetch(`${API_BASE}/api/ReturnOrders/${id}`, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const ro = await res.json();

        document.getElementById("modalReturnId").textContent = ro.returnID ?? id;
        document.getElementById("modalReceiptId").textContent = ro.receiptID ?? "‚Äî";
        document.getElementById("modalStatus").textContent = ro.status ?? "";
        document.getElementById("modalCreatedAt").textContent =
          ro.createdAt ? new Date(ro.createdAt).toLocaleString("vi-VN") : "";

        const lines = ro.details ?? [];
        const tbody = document.getElementById("modalReturnLines");
        if (!lines.length) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Kh√¥ng c√≥ chi ti·∫øt.</td></tr>`;
        } else {
          tbody.innerHTML = lines.map(d => `
            <tr>
              <td>${d.goodID}</td>
              <td>${d.good?.name ?? ""}</td>
              <td>${d.batch?.batchNo ?? "‚Äî"}</td>
              <td class="text-end">${d.quantityReturned ?? 0}</td>
              <td>${d.reason ?? ""}</td>
            </tr>
          `).join("");
        }
        new bootstrap.Modal(document.getElementById("returnModal")).show();
      } catch (e) {
        alert("L·ªói t·∫£i chi ti·∫øt: " + e.message);
      }
    }

    document.getElementById("poid").addEventListener("input", e => {
      if (e.target.value <= 0) e.target.value = "";
    });

    // ==== Sidebar ====
    fetch("sidebar.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("sidebar").innerHTML = html;
      })
      .catch(err => console.error("L·ªói t·∫£i sidebar:", err));


    window.addEventListener("DOMContentLoaded", loadReturns);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
