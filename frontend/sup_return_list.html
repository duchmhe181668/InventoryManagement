<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Supplier ‚Äî Phi·∫øu tr·∫£ h√†ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #0d6efd;
      --text: #111;
      --bg: #fff;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    body { padding: 20px; background: var(--bg); color: var(--text); }
    .layout { display: flex; gap: 24px; align-items: flex-start; }
    #sidebar {
      position: sticky; top: 20px; min-height: calc(100vh - 40px);
      width: 260px; background: var(--primary); color: #fff;
      border-radius: 10px; display: flex; flex-direction: column; padding: 16px;
    }
    #sidebar .nav-link { color: rgba(255,255,255,0.92); padding-left: 0; }
    #sidebar .nav-link.active { font-weight: 600; color: #fff; }
    .muted { color: var(--muted); }
    .table-narrow th,.table-narrow td { padding: .4rem .6rem; border-color: var(--border); }
    tr.clickable:hover { background: #f8fafc; cursor: pointer; }
    .detail-cell { padding: 0!important; background: #fafafa; }
    .slide { overflow: hidden; max-height: 0; transition: max-height 280ms ease; border-top: 1px solid var(--border); }
    .slide-inner { padding: 12px 16px; }
    #msg { color: #e0e7ff; }
  </style>
</head>

<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside id="sidebar">
      <div>
        <h5 class="mb-3">Menu</h5>
        <ul class="nav flex-column">
          <li class="nav-item"><a href="index.html" class="nav-link">Trang ch·ªß</a></li>
          <li class="nav-item"><a href="sup_po_list.html" class="nav-link">ƒê∆°n h√†ng</a></li>
          <li class="nav-item"><a href="sup_receipt_list.html" class="nav-link">Bi√™n lai</a></li>
          <li class="nav-item"><a href="sup_return_list.html" class="nav-link active">Phi·∫øu tr·∫£ h√†ng</a></li>
        </ul>
      </div>
      <div id="msg" class="mt-3 small"></div>
    </aside>

    <!-- Main -->
    <main class="flex-grow-1">
      <div class="d-flex align-items-center gap-2">
        <h2 class="m-0">Danh s√°ch phi·∫øu tr·∫£ h√†ng</h2>
        <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
          <label class="form-label m-0">POID</label>
          <input type="number" id="poid" class="form-control form-control-sm" style="width:100px" placeholder="Nh·∫≠p POID" />
          <label class="form-label m-0">T·ª´ ng√†y</label>
          <input type="date" id="fromDate" class="form-control form-control-sm" style="width:150px" />
          <label class="form-label m-0">ƒê·∫øn ng√†y</label>
          <input type="date" id="toDate" class="form-control form-control-sm" style="width:150px" />
          <label class="form-label m-0">Tr·∫°ng th√°i</label>
          <select id="status" class="form-select form-select-sm" style="width:160px">
            <option value="">T·∫•t c·∫£</option>
            <option value="Submitted">ƒê√£ g·ª≠i</option>
            <option value="Confirmed">ƒê√£ x√°c nh·∫≠n</option>
          </select>
          <button id="btnReload" class="btn btn-sm btn-outline-light border-light">
            <i class="bi bi-funnel"></i> L·ªçc
          </button>
        </div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-bordered table-hover table-narrow">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Ng√†y t·∫°o</th>
              <th>Ng√†y nh·∫≠n</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="returnTableBody"></tbody>
        </table>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="small text-muted" id="pageInfo"></div>
          <div class="btn-group">
            <button id="prevPage" class="btn btn-sm btn-outline-secondary">&laquo; Tr∆∞·ªõc</button>
            <button id="nextPage" class="btn btn-sm btn-outline-secondary">Sau &raquo;</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = "https://localhost:7225";
    const token = sessionStorage.getItem("accessToken") || localStorage.getItem("accessToken");
    const supplierId = sessionStorage.getItem("supplierId") || localStorage.getItem("supplierId");

    let currentOpenRowId = null, currentDetailTr = null;
    let allReturns = []; let currentPage = 1; const pageSize = 10;

    const authHeaders = () => ({ "Authorization": `Bearer ${token}`, "Content-Type": "application/json" });
    const setMsg = (t, cls="muted") => { 
      const el=document.getElementById("msg"); 
      el.style.display = 'none';
      el.className=cls; 
      el.textContent=t; 
    };

    async function loadReturns() {
      if (!token || !supplierId) { alert("‚ö†Ô∏è Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n!"); location.href="login.html"; return; }
      setMsg("ƒêang t·∫£i danh s√°ch phi·∫øu tr·∫£...");
      try {
  const status = document.getElementById("status").value;
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const poid = document.getElementById("poid").value;

  const url = new URL(`${API_BASE}/api/ReturnOrders/by-supplier/${supplierId}`);
  if (status) url.searchParams.set("status", status);
  if (from) url.searchParams.set("from", from);
  if (to) url.searchParams.set("to", to);
  if (poid) url.searchParams.set("poid", poid);

  // üß© G·ªåI API tr∆∞·ªõc khi ƒë·ªçc ph·∫£n h·ªìi
  const res = await fetch(url, { headers: authHeaders() });

  // üß© ƒê·ªçc ph·∫£n h·ªìi an to√†n tr√°nh l·ªói "Unexpected end of JSON input"
  let data = [];
  const text = await res.text();

  if (text && text.trim().length > 0) {
    try {
      data = JSON.parse(text);
    } catch (err) {
      console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ parse JSON:", err);
      data = [];
    }
  } else {
    console.log("‚ÑπÔ∏è API tr·∫£ v·ªÅ 204 ho·∫∑c body r·ªóng.");
    data = [];
  }

  // üîç N·∫øu API kh√¥ng tr·∫£ g√¨ -> hi·ªÉn th·ªã ‚ÄúKh√¥ng c√≥ d·ªØ li·ªáu‚Äù
  if (!Array.isArray(data) || data.length === 0) {
    const tbody = document.getElementById("returnTableBody");
    tbody.innerHTML = `<tr><td colspan="6" class="text-center muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
    document.getElementById("pageInfo").textContent = "";
    setMsg("Kh√¥ng t√¨m th·∫•y phi·∫øu tr·∫£ h√†ng n√†o.", "muted");
    return;
  }

  allReturns = data;
  currentPage = 1;
  renderTablePage();
  setMsg(`ƒê√£ t·∫£i ${allReturns.length} phi·∫øu tr·∫£ h√†ng.`, "ok");
}
catch (e) {
  console.error(e);
  setMsg("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu.", "text-danger");
}

    }

    function renderTablePage(){
      const total=allReturns.length,totalPages=Math.ceil(total/pageSize)||1;
      const start=(currentPage-1)*pageSize;
      renderTable(allReturns.slice(start,start+pageSize));
      document.getElementById("pageInfo").textContent=`Trang ${currentPage}/${totalPages} ‚Äî ${total} phi·∫øu`;
      document.getElementById("prevPage").disabled=currentPage<=1;
      document.getElementById("nextPage").disabled=currentPage>=totalPages;
    }
    document.getElementById("prevPage").onclick=()=>{if(currentPage>1){currentPage--;renderTablePage();}};
    document.getElementById("nextPage").onclick=()=>{if(currentPage<Math.ceil(allReturns.length/pageSize)){currentPage++;renderTablePage();}};

    function renderTable(list){
      const tbody=document.getElementById("returnTableBody");
      tbody.innerHTML="";
      if(!list.length){tbody.innerHTML=`<tr><td colspan="6" class="text-center muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;return;}
      list.forEach(ro=>{
        const id=ro.returnID??ro.id;
        const createdAt=ro.createdAt?new Date(ro.createdAt).toLocaleString():"";
        const confirmedAt=ro.confirmedAt?new Date(ro.confirmedAt).toLocaleString():"‚Äî";
        const tr=document.createElement("tr");
        tr.className="clickable"; tr.dataset.id=id;
        tr.innerHTML=`
          <td>${id}</td>
          <td>${createdAt}</td>
          <td>${confirmedAt}</td>
          <td>${ro.status??""}</td>
          <td>${ro.note??""}</td>`;
        tr.onclick=async()=>{if(currentOpenRowId===id){await closeDetail();return;}await closeDetail();await openDetailBelow(tbody,tr,id,ro.status);};
        tbody.appendChild(tr);
      });
    }

    async function openDetailBelow(tbody,anchorTr,id,status){
      const detailTr=document.createElement("tr");
      detailTr.className="detail-row";
      const td=document.createElement("td");
      td.colSpan=6; td.className="detail-cell";
      td.innerHTML=`<div class="slide"><div class="slide-inner" id="detail-${id}"><div class="muted">ƒêang t·∫£i chi ti·∫øt phi·∫øu #${id}...</div></div></div>`;
      detailTr.appendChild(td); anchorTr.insertAdjacentElement("afterend",detailTr);
      try{
        const res=await fetch(`${API_BASE}/api/ReturnOrders/${id}`,{headers:authHeaders()});
        const box=document.getElementById(`detail-${id}`);
        if(!res.ok) box.innerHTML=`<p class="text-danger">L·ªói t·∫£i chi ti·∫øt.</p>`;
        else box.innerHTML=renderDetailHtml(await res.json(),status);
      }catch{document.getElementById(`detail-${id}`).innerHTML=`<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt.</p>`;}
      const slide=detailTr.querySelector(".slide");
      requestAnimationFrame(()=>{slide.style.maxHeight=slide.scrollHeight+"px";});
      currentOpenRowId=id; currentDetailTr=detailTr;
    }

    function closeDetail(){return new Promise(resolve=>{if(!currentDetailTr)return resolve();const slide=currentDetailTr.querySelector(".slide");slide.addEventListener("transitionend",()=>{currentDetailTr.remove();currentDetailTr=null;currentOpenRowId=null;resolve();},{once:true});slide.style.maxHeight="0px";});}

    function renderDetailHtml(ro,status){
      const lines=(ro.details??[]).map(d=>`
        <tr>
          <td>${d.goodID}</td>
          <td>${d.good?.name??""}</td>
          <td>${d.unit??d.good?.unit??"‚Äî"}</td>
          <td>${d.batch?.batchNo??"‚Äî"}</td>
          <td>${d.orderedQuantity??0}</td>
          <td>${d.quantityReturned??0}</td>
          <td class="text-end">${d.unitCost?.toLocaleString()??0}</td>
          <td>${d.reason??""}</td>
        </tr>`).join("");
      const confirmBtn = status==="Submitted"
        ? `<button class="btn btn-sm btn-success mt-2" onclick="confirmReturn(${ro.returnID})">
            <i class='bi bi-check-circle'></i> X√°c nh·∫≠n ƒë√£ nh·∫≠n h√†ng tr·∫£
           </button>`
        : `<span class="badge bg-secondary mt-2">ƒê√£ x√°c nh·∫≠n</span>`;
      return `
        <div class="d-flex justify-content-between align-items-start">
          <div><strong>Ghi ch√∫:</strong> ${ro.note??""}</div>
          ${confirmBtn}
        </div>
        <div class="mt-2">
          <table class="table table-bordered table-sm">
            <thead class="table-light">
              <tr>
                <th>ID h√†ng</th><th>T√™n h√†ng</th><th>ƒê∆°n v·ªã</th><th>T√™n l√¥</th>
                <th>S·ªë l∆∞·ª£ng ƒë·∫∑t</th><th>S·ªë l∆∞·ª£ng tr·∫£</th><th>ƒê∆°n gi√°</th><th>L√Ω do</th>
              </tr>
            </thead>
            <tbody>${lines||`<tr><td colspan="8" class="text-center muted">Kh√¥ng c√≥ chi ti·∫øt</td></tr>`}</tbody>
          </table>
        </div>`;
    }

    async function confirmReturn(id){
      if(!confirm(`X√°c nh·∫≠n ƒë√£ nh·∫≠n h√†ng tr·∫£ t·ª´ kho cho phi·∫øu #${id}?`))return;
      try{
        const res=await fetch(`${API_BASE}/api/ReturnOrders/${id}/confirm?supplierId=${supplierId}`,{method:"PATCH",headers:authHeaders()});
        const data=await res.json();
        if(!res.ok)throw new Error(data.error||JSON.stringify(data));
        alert("‚úÖ "+data.message);
        await closeDetail(); await loadReturns();
      }catch(e){console.error(e);alert("‚ùå L·ªói khi x√°c nh·∫≠n: "+e.message);}
    }

    ["btnReload","status","fromDate","toDate","poid"].forEach(id=>{
      const el=document.getElementById(id);
      if(id==="btnReload")el.onclick=loadReturns;else el.onchange=loadReturns;
    });
    loadReturns(); window.confirmReturn=confirmReturn;
  </script>
</body>
</html>
