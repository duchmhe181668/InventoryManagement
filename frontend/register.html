<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Đăng ký - InventoryManagement</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{min-height:100vh;background:#f5f7fb;display:flex;align-items:center;justify-content:center}
    .card{width:100%;max-width:520px;border:none;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .form-control:focus{box-shadow:none;border-color:#0d6efd}
  </style>
</head>
<body>
<div class="card p-4">
  <h5 class="mb-3 text-center">Tạo tài khoản</h5>
  <div id="alert" class="alert d-none" role="alert"></div>

  <form id="frm" novalidate>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Tài khoản</label>
        <input id="username" class="form-control" required />
        <div class="invalid-feedback">Required</div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Tên hiển thị</label>
        <input id="name" class="form-control" required />
        <div class="invalid-feedback">Required</div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Email</label>
        <input id="email" type="email" class="form-control" />
      </div>
      <div class="col-md-6">
        <label class="form-label">Số điện thoại</label>
        <input id="phone" class="form-control" />
      </div>

      <div class="col-md-6">
        <label class="form-label">Mật khẩu</label>
        <input id="password" type="password" class="form-control" required minlength="6" />
        <div class="invalid-feedback">≥ 6 ký tự</div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Xác nhận mật khẩu</label>
        <input id="confirm" type="password" class="form-control" required minlength="6" />
        <div class="invalid-feedback">Không khớp</div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Vai trò</label>
        <select id="role" class="form-select">
          <!-- Nếu chưa có RolesController, tạm hard-code: -->
          <option value="Supplier">Supplier</option>
          <option value="StoreManager">StoreManager</option>
          <option value="WarehouseManager">WarehouseManager</option>
          <option value="Administrator">Administrator</option>
        </select>
      </div>

      <div class="col-md-6 d-flex align-items-end">
        <div class="form-check">
          <input id="remember" class="form-check-input" type="checkbox">
          <label class="form-check-label" for="remember">Ghi nhớ</label>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <a class="btn btn-outline-secondary flex-fill" href="login.html">Trở lại</a>
      <button id="btnReg" type="submit" class="btn btn-primary flex-fill">
        <span id="spn" class="spinner-border spinner-border-sm me-2 d-none"></span>
        Đăng ký
      </button>
    </div>
  </form>
</div>

<script>
(function(){
  const ENDPOINTS = [
    'https://localhost:7225/api/Auth/register',
    'http://localhost:5146/api/Auth/register'
  ];
  const alertBox = document.getElementById('alert');
  const frm = document.getElementById('frm');
  const btn = document.getElementById('btnReg');
  const spn = document.getElementById('spn');

  function showAlert(msg, type='danger'){
    alertBox.textContent = msg;
    alertBox.className = 'alert alert-'+type;
  }
  function clearAlert(){
    alertBox.className = 'alert d-none';
    alertBox.textContent = '';
  }
  function busy(b){
    btn.disabled = b;
    spn.classList.toggle('d-none', !b);
  }
  function persistAuth(result, remember) {
    const store = remember ? localStorage : sessionStorage;
    try { store.setItem('authUser', JSON.stringify(result)); } catch {}
    const token = result.accessToken || '';
    try { store.setItem('accessToken', token); } catch {}
    try { store.setItem('authToken',  token); } catch {}
    try { store.setItem('tokenType', result.tokenType || 'Bearer'); } catch {}
    try { store.setItem('authRole',  result.role || ''); } catch {}
    try { store.setItem('authUserName', result.username || ''); } catch {}
    if (result.storeId != null)    try { store.setItem('storeId',    String(result.storeId)); } catch {}
    if (result.supplierId != null) try { store.setItem('supplierId', String(result.supplierId)); } catch {}
    if (typeof result.expiresInSeconds === 'number') {
      const expireAt = Date.now() + (result.expiresInSeconds * 1000);
      try { store.setItem('tokenExpireAt', String(expireAt)); } catch {}
    }
  }
  function redirectByRole(role) {
    const r = (role || '').toLowerCase();
    if (['administrator','warehousemanager','storemanager'].includes(r)) location.href = 'home.html';
    else if (r === 'supplier') location.href = 'supplier.html';
    else location.href = 'home.html';
  }
  async function register(payload){
    let last;
    for (const url of ENDPOINTS){
      try{
        const res = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok){
          const msg = typeof data==='string' ? data : (data.title || data.message || 'Đăng ký thất bại');
          throw new Error(msg);
        }
        return data; // RegisterResponse (có token)
      }catch(e){ last = e; }
    }
    throw last || new Error('Không thể gọi API đăng ký.');
  }

  frm.addEventListener('submit', async (e)=>{
    e.preventDefault(); clearAlert();
    const u = document.getElementById('username').value.trim();
    const n = document.getElementById('name').value.trim();
    const em = document.getElementById('email').value.trim();
    const ph = document.getElementById('phone').value.trim();
    const p1 = document.getElementById('password').value;
    const p2 = document.getElementById('confirm').value;
    const role = document.getElementById('role').value;
    const remember = document.getElementById('remember').checked;

    if (!u || !n || !p1 || !p2) { showAlert('Vui lòng nhập đủ thông tin bắt buộc.'); return; }
    if (p1.length < 6) { showAlert('Mật khẩu tối thiểu 6 ký tự.'); return; }
    if (p1 !== p2) { showAlert('Xác nhận mật khẩu không khớp.'); return; }

    busy(true);
    try{
      const payload = { username: u, password: p1, name: n, email: em || null, phoneNumber: ph || null, roleName: role };
      const result = await register(payload);
      // Lưu phiên & chuyển trang như login
      persistAuth(result, remember);
      showAlert('✅ Đăng ký thành công!', 'success');
      setTimeout(()=> redirectByRole(result.role), 500);
    }catch(err){
      showAlert(err?.message || 'Đăng ký thất bại');
    }finally{
      busy(false);
    }
  });
})();
</script>
</body>
</html>
