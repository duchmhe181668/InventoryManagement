<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Đăng ký - InventoryManagement</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root{
      --primary-start:#2f80ed; --primary-end:#1c64f2;
      --border:#e5e7eb; --muted:#6b7280; --field:#f3f6ff;
      --radius-card:26px; --radius-btn:16px; --radius-pill:20px;
      --shadow-card:0 26px 70px rgba(28,100,242,.12), 0 10px 24px rgba(16,24,40,.08);
    }
    body{
      min-height:100vh;
      background: radial-gradient(1400px 700px at 15% 15%, #eef4ff 0%, #f7f9fc 40%, #f5f7fb 100%);
      display:flex; align-items:center; justify-content:center; padding:28px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color:#0f172a;
    }
    .card-wrap{
      width:100%; max-width:680px; border:none; border-radius:var(--radius-card);
      background:#fff; box-shadow:var(--shadow-card); padding:28px 26px;
    }
    .title{ font-weight:800; color:#111827; }
    .title i{ color:#1c64f2; }
    .sub{ color:var(--muted); }

    /* pill input group */
    .input-group.pill{
      border:1px solid var(--border); border-radius:var(--radius-pill);
      overflow:hidden; background:var(--field);
    }
    .input-group.pill:focus-within{ border-color:#86b7fe; box-shadow:0 0 0 .2rem rgba(13,110,253,.12); background:#fff; }
    .input-group.pill > .input-group-text,
    .input-group.pill > .form-control,
    .input-group.pill > .btn-icon{ border:0 !important; border-radius:0 !important; background:transparent; }
    .input-group.pill > .input-group-text{ padding:.72rem .9rem; color:#334155; }
    .input-group.pill > .form-control{ padding:.84rem .95rem; }
    .input-group.pill > .btn-icon{ display:flex; align-items:center; justify-content:center; padding:.72rem .9rem; background:#fff; cursor:pointer; }

    .form-label{ margin-bottom:.4rem; font-weight:600; }

    .btn-primary{
      border:none; border-radius:var(--radius-btn); padding:.95rem 1rem; font-weight:700;
      background-image:linear-gradient(180deg,var(--primary-start),var(--primary-end));
      box-shadow:0 10px 24px rgba(28,100,242,.24), 0 4px 10px rgba(28,100,242,.18);
    }
    .btn-primary:hover{ filter:brightness(.98); background-image:linear-gradient(180deg,var(--primary-end),var(--primary-end)); }
    .btn-outline-secondary{ border-radius:var(--radius-btn); padding:.95rem 1rem; }
    .divider{ height:1px; background:#edf1f7; margin:14px 0; }
  </style>
</head>
<body>
  <div class="card-wrap">
    <div class="mb-3 text-center">
      <div class="title h4 mb-1"><i class="bi bi-person-plus-fill me-2"></i>Tạo tài khoản</div>
      <div class="sub">Điền thông tin bên dưới để tạo một tài khoản mới</div>
    </div>

    <div id="alert" class="alert d-none" role="alert"></div>

    <form id="frm" novalidate>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Tài khoản <span class="text-danger">*</span></label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
            <input id="username" class="form-control" required placeholder="username">
          </div>
          <div class="invalid-feedback">Vui lòng nhập tài khoản.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Tên hiển thị <span class="text-danger">*</span></label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-person-badge-fill"></i></span>
            <input id="name" class="form-control" required placeholder="Tên của bạn">
          </div>
          <div class="invalid-feedback">Vui lòng nhập tên hiển thị.</div>
        </div>

        <div class="col-md-6">
  <label class="form-label">Email</label>
  <div class="input-group pill">
    <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
    <input id="email" type="email" class="form-control"
           placeholder="you@gmail.com"
           pattern="^[a-zA-Z0-9._%+-]+@gmail\.com$" />
  </div>
  <div class="invalid-feedback">Email phải có dạng <b>@gmail.com</b>.</div>
</div>

        <div class="col-md-6">
  <label class="form-label">Số điện thoại</label>
  <div class="input-group pill">
    <span class="input-group-text"><i class="bi bi-telephone-fill"></i></span>
    <input id="phone" class="form-control"
           placeholder="090xxxxxxx"
           inputmode="numeric" maxlength="10"
           pattern="^\d{10}$" />
  </div>
  <div class="invalid-feedback">Số điện thoại phải gồm đúng <b>10 số</b>.</div>
</div>

        <div class="col-md-6">
  <label class="form-label">Mật khẩu <span class="text-danger">*</span></label>
  <div class="input-group pill">
    <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
    <input id="password" type="password" class="form-control"
           required minlength="6" placeholder="••••••••">
    <button type="button" class="btn btn-icon" id="togglePw1" title="Hiện/ẩn mật khẩu">
      <i class="bi bi-eye"></i>
    </button>
  </div>
  <div class="invalid-feedback">Mật khẩu tối thiểu 6 ký tự.</div>
</div>

        <div class="col-md-6">
          <label class="form-label">Xác nhận mật khẩu <span class="text-danger">*</span></label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-shield-lock-fill"></i></span>
            <input id="confirm" type="password" class="form-control" required minlength="6" placeholder="••••••••">
            <button type="button" class="btn btn-icon" id="togglePw2" title="Hiện/ẩn mật khẩu"><i class="bi bi-eye"></i></button>
          </div>
          <div class="invalid-feedback">Xác nhận mật khẩu không khớp.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Vai trò</label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-people-fill"></i></span>
            <select id="role" class="form-select" style="border:0;background:transparent;">
              <option value="Supplier">Supplier</option>
              <option value="StoreManager">StoreManager</option>
              <option value="WarehouseManager">WarehouseManager</option>
            </select>
          </div>
        </div>

        <div class="col-md-6 d-flex align-items-center">
          <div class="form-check mt-3">
            <input id="remember" class="form-check-input" type="checkbox">
            <label class="form-check-label" for="remember">Đăng nhập sau khi tạo</label>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="d-flex gap-2 mt-2">
        <a class="btn btn-outline-secondary flex-fill" href="login.html"><i class="bi bi-arrow-left me-1"></i> Trở lại</a>
        <button id="btnReg" type="submit" class="btn btn-primary flex-fill">
          <span id="spn" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          <i class="bi bi-person-plus me-1"></i> Đăng ký
        </button>
      </div>
    </form>
  </div>

<script>
(function(){
  // ===== API endpoints =====
  const ENDPOINTS = [
    'https://localhost:7225/api/Auth/register',
  ];

  // ===== DOM =====
  const alertBox = document.getElementById('alert');
  const frm = document.getElementById('frm');
  const btn = document.getElementById('btnReg');
  const spn = document.getElementById('spn');
  const pw1 = document.getElementById('password');
  const pw2 = document.getElementById('confirm');

  // Toggle eyes
  const togglePw1 = document.getElementById('togglePw1');
  const togglePw2 = document.getElementById('togglePw2');
  togglePw1.addEventListener('click', () => {
    const i = togglePw1.querySelector('i');
    pw1.type = pw1.type === 'password' ? 'text' : 'password';
    i.classList.toggle('bi-eye'); i.classList.toggle('bi-eye-slash');
  });
  togglePw2.addEventListener('click', () => {
    const i = togglePw2.querySelector('i');
    pw2.type = pw2.type === 'password' ? 'text' : 'password';
    i.classList.toggle('bi-eye'); i.classList.toggle('bi-eye-slash');
  });

  // ===== UI helpers =====
  function showAlert(msg, type='danger'){
    alertBox.textContent = msg;
    alertBox.className = 'alert alert-'+type;
    alertBox.classList.remove('d-none');
  }
  function clearAlert(){ alertBox.className = 'alert d-none'; alertBox.textContent = ''; }
  function busy(b){ btn.disabled = b; spn.classList.toggle('d-none', !b); }

  // ===== Auth helpers =====
  function persistAuth(result, remember) {
    const store = remember ? localStorage : sessionStorage;
    try { store.setItem('authUser', JSON.stringify(result)); } catch {}
    const token = result.accessToken || '';
    try { store.setItem('accessToken', token); } catch {}
    try { store.setItem('authToken',  token); } catch {}
    try { store.setItem('tokenType', result.tokenType || 'Bearer'); } catch {}
    try { store.setItem('authRole',  result.role || ''); } catch {}
    try { store.setItem('authUserName', result.username || ''); } catch {}
    if (result.storeId != null)    try { store.setItem('storeId',    String(result.storeId)); } catch {}
    if (result.supplierId != null) try { store.setItem('supplierId', String(result.supplierId)); } catch {}
    if (typeof result.expiresInSeconds === 'number') {
      const expireAt = Date.now() + (result.expiresInSeconds * 1000);
      try { store.setItem('tokenExpireAt', String(expireAt)); } catch {}
    }
  }
  function redirectByRole(role) {
    const r = (role || '').toLowerCase();
    if (['administrator','warehousemanager','storemanager'].includes(r)) location.href = 'home.html';
    else if (r === 'supplier') location.href = 'supplier.html';
    else location.href = 'home.html';
  }

  // ===== Register call =====
  async function register(payload){
    let last;
    for (const url of ENDPOINTS){
      try{
        const res = await fetch(url, {
          method:'POST',
          headers:{ 'Accept':'application/json', 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok){
          const msg = typeof data==='string' ? data : (data.title || data.message || 'Đăng ký thất bại');
          throw new Error(msg);
        }
        return data; // LoginResponse từ server
      }catch(e){ last = e; }
    }
    throw last || new Error('Không thể gọi API đăng ký.');
  }

  // ===== Submit =====
  frm.addEventListener('submit', async (e)=>{
    e.preventDefault(); clearAlert();

    // HTML5 validity
    if (!frm.checkValidity()){
      frm.classList.add('was-validated');

      const em = document.getElementById('email').value.trim();
  const ph = document.getElementById('phone').value.trim();
  const errs = [];
  if (em && !/^[a-zA-Z0-9._%+-]+@gmail\.com$/i.test(em)) errs.push('Email phải là @gmail.com');
  if (ph && !/^\d{10}$/.test(ph)) errs.push('Số điện thoại phải gồm 10 số');
  if (errs.length) showAlert(errs.join('. ') + '.', 'danger');

      return;
    }

    const u  = document.getElementById('username').value.trim();
    const n  = document.getElementById('name').value.trim();
    const em = document.getElementById('email').value.trim();
    const ph = document.getElementById('phone').value.trim();
    const p1 = pw1.value;
    const p2 = pw2.value;
    const role = document.getElementById('role').value;
    const remember = document.getElementById('remember').checked;

    if (p1.length < 6){ showAlert('Mật khẩu tối thiểu 6 ký tự.'); return; }
    if (p1 !== p2){ showAlert('Xác nhận mật khẩu không khớp.'); return; }

    busy(true);
    try{
      const payload = {
        username: u,
        password: p1,
        name: n,
        email: em || null,
        phoneNumber: ph || null,
        roleName: role
      };
      const result = await register(payload);
      persistAuth(result, remember);
      showAlert('✅ Đăng ký thành công!', 'success');
      setTimeout(()=> redirectByRole(result.role), 500);
    }catch(err){
      showAlert(err?.message || 'Đăng ký thất bại');
    }finally{
      busy(false);
    }
  });
})();
</script>
</body>
</html>
