<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Danh sách Phiếu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="purchase_order_list.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body>
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
        <a href="../home.html" class="btn btn-outline-secondary me-3">
            <i class="fas fa-arrow-left"></i> Quay lại
        </a>
        <h4 class="m-0 text-primary">Quản lý Phiếu yêu cầu </h4>
    </div>
    <a href="../purchase_order/purchase_order.html" class="btn btn-primary rounded-pill">
      <i class="fa-solid fa-plus me-2"></i>Tạo Phiếu Mua Hàng
    </a>
  </div>

  <div class="card p-3 p-lg-4">
    <div class="table-responsive">
      <table class="table table-sm align-middle table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Loại phiếu</th>
            <th>Chi tiết</th>
            <th class="text-center">Trạng thái</th>
            <th>Ngày tạo</th>
            <th class="text-end">Hành động</th>
          </tr>
        </thead>
        <tbody id="orderTableBody">
          <tr><td colspan="6" class="text-center p-5"><div class="spinner-border spinner-border-sm"></div> Đang tải...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const API_BASE = 'https://localhost:7225/api';

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) { return null; }
  }

  function checkAuth() {
      const token = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
      if (!token) {
          alert("Bạn chưa đăng nhập hoặc phiên đã hết hạn. Vui lòng đăng nhập lại.");
          window.location.href = '../login.html';
          return { token: null, hasPermission: false };
      }
      let userRole = localStorage.getItem('authRole') || sessionStorage.getItem('authRole');
      if (!userRole) {
          const payload = parseJwt(token);
          userRole = payload ? (payload['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] || '') : '';
      }
      const roleToCompare = (userRole || '').toLowerCase();
      const allowedRoles = ['warehousemanager', 'storemanager', 'administrator'];
      if (!allowedRoles.includes(roleToCompare)) {
          alert("Bạn không có quyền truy cập chức năng này.");
          window.location.href = '../home.html';
          return { token, hasPermission: false };
      }
      return { token, hasPermission: true };
  }
  
  const esc = s => (s??'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  function getStatusBadge(status) {
      const statuses = { 'Draft': 'primary', 'Submitted': 'info', 'Accepted': 'info', 'Approved': 'success', 'Shipping': 'warning', 'Shipped': 'warning', 'Receiving': 'warning', 'Received': 'success', 'Cancelled': 'secondary' };
      const color = statuses[status] || 'dark';
      return `<span class="badge bg-${color}-subtle text-${color}-emphasis border border-${color}-subtle">${esc(status)}</span>`;
  }

  function renderTable(orders) {
    const tbody = document.getElementById('orderTableBody');
    tbody.innerHTML = '';
    if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center p-5 text-muted">Không tìm thấy phiếu nào.</td></tr>`;
        return;
    }
    orders.forEach(order => {
      const tr = document.createElement('tr');
      const pageUrl = order.type === 'Purchase Order' ? `../purchase_order/purchase_order.html` : `../transfer/transfer.html`;
      
      const actionButton = order.status === 'Draft'
        ? `<a href="${pageUrl}?id=${order.id}&edit=true" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-pencil me-1"></i> Sửa</a>`
        : `<a href="${pageUrl}?id=${order.id}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-eye me-1"></i> Xem</a>`;
      
      // SỬA LỖI HIỂN THỊ TRẠNG THÁI: Truyền `order.status` vào hàm getStatusBadge
      tr.innerHTML = `
        <td><strong>#${order.id}</strong></td>
        <td>${esc(order.type)}</td>
        <td>${esc(order.details)}</td>
        <td class="text-center">${getStatusBadge(order.status)}</td>
        <td>${new Date(order.createdAt).toLocaleString('vi-VN')}</td>
        <td class="text-end">${actionButton}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function fetchOrders(token) {
    const tbody = document.getElementById('orderTableBody');
    try {
      const res = await fetch(`${API_BASE}/Orders/all-orders`, {
        headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
      });
      if (!res.ok) {
        if(res.status === 401 || res.status === 403) checkAuth();
        else throw new Error(`HTTP ${res.status}`);
      }
      const allOrders = await res.json();
      renderTable(allOrders);
    } catch (err) {
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="6" class="text-center p-5 text-danger">Lỗi khi tải dữ liệu.</td></tr>`;
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    const authResult = checkAuth();
    if(authResult.hasPermission){
        fetchOrders(authResult.token);
    }
  });
</script>
</body>
</html>

