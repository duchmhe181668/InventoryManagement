<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tạo phiếu Request (Warehouse → Supplier)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="purchase_order.css" rel="stylesheet">
  
</head>
<body>
<div class="container container-narrow py-4">

  <div class="d-flex align-items-center mb-3">
    <button class="btn btn-outline-secondary icon-btn me-3" onclick="location.href='../home.html'">
      <i class="fa-solid fa-arrow-left"></i>
    </button>
    <h4 class="m-0 text-primary">Tạo phiếu danh sách hàng (Kho → Nhà Cung Cấp)</h4>
  </div>

  <div class="row g-3">
    <!-- Left 70% -->
    <div class="col-lg-8">
      <div class="card p-3 p-lg-4">
        <div class="mb-2 fw-semibold text-primary">Tìm & thêm mặt hàng</div>

        <!-- Product search with "+" append -->
        <div class="position-relative mb-3">
          <div class="input-group">
            <input id="goodSearch" class="form-control" placeholder="Nhập tên hoặc mã sản phẩm.." autocomplete="off">
            <button id="btnAddNewGood" class="btn btn-primary btn-append icon-btn" type="button" title="Thêm sản phẩm mới">
              <i class="fa-solid fa-plus"></i>
            </button>
          </div>
          <div id="goodResults" class="result-list d-none">
            <ul class="list-group"></ul>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width:60px">STT</th>
                <th>Tên hàng</th>
                <th>Mã Sản Phẩm</th>
                <th style="width:100px">Đơn vị</th>
                <th style="width:160px">Số lượng</th>
                <th style="width:80px" class="text-center">Thao tác</th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right 30% -->
    <div class="col-lg-4">
      <div class="card p-3 p-lg-4 sticky-right">
        <div class="mb-2 fw-semibold text-primary">Chọn nhà cung cấp</div>
        <div class="position-relative mb-3">
          <input id="supplierSearch" class="form-control" placeholder="Nhập tên nhà cung cấp.." autocomplete="off">
          <div id="supplierResults" class="result-list d-none">
            <ul class="list-group"></ul>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <span class="fw-semibold">Tổng mặt hàng</span>
          <span id="totalItems" class="pill-badge">0</span>
        </div>

        <div class="d-grid gap-2">
          <button class="btn btn-danger rounded-pill" id="btnClearAll">
            <i class="fa-solid fa-trash-can me-2"></i>Xóa hết
          </button>
          <button class="btn btn-primary rounded-pill" id="btnConfirm">
            <i class="fa-solid fa-check me-2"></i>Gửi yêu cầu
          </button>
        </div>
      </div>
    </div>
    <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

  </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const API_BASE = 'https://localhost:7225/api/orders';
  const CREATED_BY = 1;

  let items = []; // [{goodId, name, barcode, qty}]
  let supplier = null; // {supplierId, name}

  const debounce = (fn, ms=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} };
  const esc = s => (s??'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  function renderItems(){
    const tb = document.getElementById('itemsBody');
    tb.innerHTML = '';
    items.forEach((it, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
  <td>${idx+1}</td>
  <td>${esc(it.name)}</td>
  <td>${esc(it.barcode || '')}</td>
  <td>${esc(it.unit || '')}</td>   <!-- thêm ô đơn vị ở đúng vị trí -->
  <td>
    <input type="number" min="0.0001" step="0.0001"
           class="form-control form-control-sm qty-input"
           value="${it.qty}" data-idx="${idx}">
  </td>
  <td class="text-center">
    <button class="btn btn-outline-danger icon-btn" data-del="${idx}" title="Xóa">
      <i class="fa-solid fa-trash-can"></i>
    </button>
  </td>`;
      tb.appendChild(tr);
    });
    document.getElementById('totalItems').textContent = items.length.toString();

    tb.querySelectorAll('input.qty-input').forEach(inp=>{
      inp.addEventListener('change',(e)=>{
        const i = Number(e.target.dataset.idx);
        let v = Number(e.target.value);
        if(!Number.isFinite(v) || v<=0){ v = 1; }
        items[i].qty = v; e.target.value = v;
      });
    });
    tb.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const i = Number(e.currentTarget.dataset.del);
        items.splice(i,1);
        renderItems();
      });
    });
  }

  // ===== Goods search =====
  const goodSearch = document.getElementById('goodSearch');
  const goodBox = document.getElementById('goodResults');
  const goodUl = goodBox.querySelector('ul');

  goodSearch.addEventListener('input', debounce(async (e)=>{
    const q = e.target.value.trim();
    if(!q){ goodBox.classList.add('d-none'); goodUl.innerHTML=''; return; }
    try{
      const url = new URL(API_BASE + '/lookups/goods', location.origin);
      url.searchParams.set('q', q);
      url.searchParams.set('top', '20');
      const res = await fetch(url, {headers:{'Accept':'application/json'}});
      const data = await res.json(); // [{goodID,name,barcode}]
      goodUl.innerHTML = '';
      data.forEach(g=>{
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold">${esc(g.name)}</div>
              <div class="text-muted small">Barcode: ${esc(g.barcode||'')}</div>
            </div>
          </div>`;
        li.addEventListener('click', ()=>{
          const idx = items.findIndex(x=>x.goodId===g.goodID);
          if(idx>=0){ items[idx].qty = Number(items[idx].qty)+1; }
          else { items.push({goodId:g.goodID, name:g.name, barcode:g.barcode,unit: g.unit, qty:1}); }
          renderItems();
          goodBox.classList.add('d-none'); goodUl.innerHTML=''; goodSearch.value='';
        });
        goodUl.appendChild(li);
      });
      goodBox.classList.toggle('d-none', data.length===0);
    }catch(err){
      console.error(err);
      goodBox.classList.add('d-none');
    }
  }, 300));

  // "+" button for adding new goods 
  document.getElementById('btnAddNewGood').addEventListener('click', (e)=>{ /* placeholder */ });

  // ===== Supplier search =====
  const supSearch = document.getElementById('supplierSearch');
  const supBox = document.getElementById('supplierResults');
  const supUl = supBox.querySelector('ul');

  supSearch.addEventListener('input', debounce(async (e)=>{
    const q = e.target.value.trim();
    if(!q){ supBox.classList.add('d-none'); supUl.innerHTML=''; supplier=null; return; }
    try{
      const url = new URL(API_BASE + '/lookups/suppliers', location.origin);
      url.searchParams.set('q', q);
      url.searchParams.set('top', '20');
      const res = await fetch(url, {headers:{'Accept':'application/json'}});
      const data = await res.json(); // [{supplierID,name,...}]
      supUl.innerHTML = '';
      data.forEach(s=>{
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.innerHTML = `
          <div class="fw-semibold">${esc(s.name)}</div>
          <div class="text-muted small">${esc(s.email||'')}${s.phoneNumber? ' • '+esc(s.phoneNumber):''}</div>`;
        li.addEventListener('click', ()=>{
          supplier = { supplierId: s.supplierID, name: s.name };
          supSearch.value = s.name; // hiển thị ngay trong input
          supBox.classList.add('d-none'); supUl.innerHTML='';
        });
        supUl.appendChild(li);
      });
      supBox.classList.toggle('d-none', data.length===0);
    }catch(err){
      console.error(err);
      supBox.classList.add('d-none');
    }
  }, 300));

  // ===== Clear All / Confirm =====
  document.getElementById('btnClearAll').addEventListener('click', ()=>{
    if(items.length===0) return;
    if(confirm('Xóa hết các mặt hàng trong danh sách?')){
      items = [];
      renderItems();
    }
  });
  // SHOW TOAST
  function showToast(message, variant='primary', delay=2800){
  const container = document.getElementById('toastContainer');
  const el = document.createElement('div');
  const color = ({success:'success', error:'danger', warning:'warning', info:'primary', primary:'primary'})[variant] || 'primary';
  el.className = `toast align-items-center bg-white border border-2 border-${color} text-${color}`;
  el.setAttribute('role','alert'); el.setAttribute('aria-live','assertive'); el.setAttribute('aria-atomic','true');
  el.innerHTML = `
    <div class="d-flex">
      <div class="toast-body fw-semibold">${(window.esc?esc(message):message)}</div>
      <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>`;
  container.appendChild(el);
  const t = new bootstrap.Toast(el, { delay });
  el.addEventListener('hidden.bs.toast', ()=> el.remove());
  t.show();
}
  // CONFIRM button
  document.getElementById('btnConfirm').addEventListener('click', async ()=>{
  if(!supplier){ showToast('Vui lòng chọn nhà cung cấp.', 'warning'); return; }
  if(items.length===0){ showToast('Danh sách mặt hàng đang trống.', 'warning'); return; }
  const payload = {
    supplierID: supplier.supplierId,
    createdBy: CREATED_BY,
    items: items.map(it=>({ goodID: it.goodId, quantity: Number(it.qty), unitPrice: 0 }))
  };
  try{
    const res = await fetch(API_BASE + '/purchase-orders', {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const err = await res.text();
      throw new Error(err || ('HTTP '+res.status));
    }
    const data = await res.json();
    showToast(`Tạo phiếu thành công! Đã gửi đến nhà cung cấp`, 'success');
    items = []; supplier = null; renderItems(); supSearch.value='';
  }catch(err){
    console.error(err);
    showToast('Lỗi khi lưu PO: ' + (err.message||err), 'error');
  }
});

  // Close dropdowns when clicking outside
  document.addEventListener('click', (e)=>{
    if(!document.getElementById('goodResults').contains(e.target) &&
       e.target !== goodSearch){
      goodBox.classList.add('d-none');
    }
    if(!document.getElementById('supplierResults').contains(e.target) &&
       e.target !== supSearch){
      supBox.classList.add('d-none');
    }
  });
</script>
</body>
</html>
