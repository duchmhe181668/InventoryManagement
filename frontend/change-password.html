<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Đổi mật khẩu - InventoryManagement</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root{
      --primary-start:#2f80ed; --primary-end:#1c64f2;
      --border:#e5e7eb; --muted:#6b7280; --field:#f3f6ff;
      --radius-card:26px; --radius-btn:16px; --radius-pill:20px;
      --shadow-card:0 26px 70px rgba(28,100,242,.12), 0 10px 24px rgba(16,24,40,.08);
    }
    body{
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px;
      background: radial-gradient(1400px 700px at 15% 15%, #eef4ff 0%, #f7f9fc 40%, #f5f7fb 100%);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color:#0f172a;
    }
    .card-wrap{
      width:100%; max-width:640px; border:none; border-radius:var(--radius-card);
      background:#fff; box-shadow:var(--shadow-card); padding:28px 26px;
    }
    .title{ font-weight:800; color:#111827; }
    .sub{ color:var(--muted); }
    .input-group.pill{
      border:1px solid var(--border); border-radius:var(--radius-pill);
      overflow:hidden; background:var(--field);
    }
    .input-group.pill:focus-within{
      border-color:#86b7fe; box-shadow:0 0 0 .2rem rgba(13,110,253,.12); background:#fff;
    }
    .input-group.pill > .input-group-text,
    .input-group.pill > .form-control,
    .input-group.pill > .btn-icon{
      border:0!important; border-radius:0!important; background:transparent;
    }
    .input-group.pill > .input-group-text{
      padding:.72rem .9rem; color:#334155;
    }
    .input-group.pill > .form-control{
      padding:.84rem .95rem;
    }
    .btn-icon{
      display:flex; align-items:center; justify-content:center;
      padding:.72rem .9rem; background:#fff; cursor:pointer;
    }
    .btn-primary{
      border:none; border-radius:var(--radius-btn); padding:.95rem 1rem;
      font-weight:700;
      background-image:linear-gradient(180deg,var(--primary-start),var(--primary-end));
      box-shadow:0 10px 24px rgba(28,100,242,.24), 0 4px 10px rgba(28,100,242,.18);
    }
    .btn-primary:hover{
      filter:brightness(.98);
      background-image:linear-gradient(180deg,var(--primary-end),var(--primary-end));
    }
    .divider{ height:1px; background:#edf1f7; margin:14px 0; }
  </style>
</head>
<body>
  <div class="card-wrap">
    <div class="mb-3 text-center">
      <div class="title h4 mb-1"><i class="bi bi-key me-2"></i>Đổi mật khẩu</div>
      <div class="sub">Nhập mật khẩu hiện tại và mật khẩu mới</div>
    </div>

    <div id="alert" class="alert d-none" role="alert"></div>

    <form id="frm" novalidate>
      <div class="row g-3">

        <div class="col-12">
          <label class="form-label">Mật khẩu hiện tại <span class="text-danger">*</span></label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
            <input id="current" type="password" class="form-control" required placeholder="••••••••">
            <button type="button" class="btn btn-icon" id="toggle1" title="Hiện/ẩn"><i class="bi bi-eye"></i></button>
          </div>
          <div class="invalid-feedback">Vui lòng nhập mật khẩu hiện tại.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Mật khẩu mới <span class="text-danger">*</span></label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-shield-lock-fill"></i></span>
            <input id="newpass" type="password" class="form-control" required minlength="6" placeholder="Tối thiểu 6 ký tự">
            <button type="button" class="btn btn-icon" id="toggle2" title="Hiện/ẩn"><i class="bi bi-eye"></i></button>
          </div>
          <div class="invalid-feedback">Mật khẩu mới tối thiểu 6 ký tự.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Xác nhận mật khẩu mới <span class="text-danger">*</span></label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-shield-check"></i></span>
            <input id="confirm" type="password" class="form-control" required minlength="6" placeholder="Nhập lại mật khẩu mới">
            <button type="button" class="btn btn-icon" id="toggle3" title="Hiện/ẩn"><i class="bi bi-eye"></i></button>
          </div>
          <div class="invalid-feedback">Xác nhận mật khẩu chưa khớp.</div>
        </div>

      </div>

      <div class="divider"></div>

      <div class="d-flex gap-2 mt-2">
        <a id="btnBack" class="btn btn-outline-secondary flex-fill">
          <i class="bi bi-arrow-left me-1"></i> Về trang chủ
        </a>
        <button id="btnSave" type="submit" class="btn btn-primary flex-fill">
          <span id="spn" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          <i class="bi bi-key me-1"></i> Đổi mật khẩu
        </button>
      </div>
    </form>
  </div>

<script>
  // Điều hướng nút Về trang chủ theo role 
  (function(){
    const btnBack = document.getElementById("btnBack");
    const rawRole = (sessionStorage.getItem("authRole") || localStorage.getItem("authRole") || "");
    const role = rawRole.replace(/\s+/g, "").toLowerCase(); 

    if (role === "supplier") {
      btnBack.href = "sup_po_list.html";
    } else if (role === "storemanager") {
      btnBack.href = "./dashboard_store/dashboard_store.html";
    } else {
      btnBack.href = "home.html";
    }
  })();
</script>

<script>
(function(){
  const ENDPOINT = 'https://localhost:7225/api/Auth/change-password';

  const alertBox = document.getElementById('alert');
  const frm = document.getElementById('frm');
  const btn = document.getElementById('btnSave');
  const spn = document.getElementById('spn');

  const cur = document.getElementById('current');
  const n1  = document.getElementById('newpass');
  const n2  = document.getElementById('confirm');

  // Toggle eyes
  const toggle1 = document.getElementById('toggle1');
  const toggle2 = document.getElementById('toggle2');
  const toggle3 = document.getElementById('toggle3');
  [ [toggle1,cur], [toggle2,n1], [toggle3,n2] ].forEach(([btn,input])=>{
    btn.addEventListener('click',()=>{
      const i = btn.querySelector('i');
      input.type = input.type === 'password' ? 'text' : 'password';
      i.classList.toggle('bi-eye'); i.classList.toggle('bi-eye-slash');
    });
  });

  //  helpers auth
  function preferLocal(){
    return localStorage.getItem('accessToken') || localStorage.getItem('authToken') ? localStorage : sessionStorage;
  }
  function getToken(){
    const store = preferLocal();
    const token = store.getItem('accessToken') || store.getItem('authToken') || '';
    const type  = store.getItem('tokenType') || 'Bearer';
    return { token, type, store, has: !!token };
  }
  function buildHeaders(extra){
    const { token, type } = getToken();
    if(!token){
      showAlert('Thiếu token. Vui lòng đăng nhập lại.', 'warning');
      setTimeout(()=> location.href='login.html', 700);
      throw new Error('No token');
    }
    return Object.assign({'Accept':'application/json','Authorization':`${type} ${token}`}, extra||{});
  }
  async function fetchWithAuth(url, opt={}){
    const opts = { method:'GET', ...opt };
    const headers = buildHeaders(opts.headers);
    if (opts.body != null && typeof opts.body !== 'string') {
      opts.body = JSON.stringify(opts.body);
      if (!headers['Content-Type'] && !headers['content-type']) {
        headers['Content-Type'] = 'application/json';
      }
    }
    opts.headers = headers;

    const res = await fetch(url, opts);
    const raw = await res.text();
    let data = raw;
    try { data = JSON.parse(raw); } catch {}

    // Phân biệt 401 sai mật khẩu hiện tại vs hết hạn token
    if (res.status === 401) {
      const msg = (typeof data === 'string') ? data : (data.message || data.title || '');
      if (/hiện tại\s*không\s*đúng/i.test(msg)) {
        const err = new Error(msg || 'Mật khẩu hiện tại không đúng.');
        err.code = 'WRONG_CURRENT_PASSWORD';
        throw err;
      }
      showAlert('Phiên đăng nhập đã hết hạn.', 'warning');
      setTimeout(()=> location.href='login.html', 700);
      const err = new Error(msg || 'Unauthorized');
      err.code = 'UNAUTHORIZED';
      throw err;
    }

    if (!res.ok) {
      const msg = (typeof data === 'string') ? data : (data.message || data.title || 'Thao tác thất bại');
      throw new Error(msg);
    }
    return data;
  }

  function showAlert(msg, type='danger'){
    alertBox.textContent = msg;
    alertBox.className = 'alert alert-'+type;
    alertBox.classList.remove('d-none');
  }
  function clearAlert(){ alertBox.className = 'alert d-none'; alertBox.textContent = ''; }
  function busy(b){ btn.disabled = b; spn.classList.toggle('d-none', !b); }

  //  submit 
  frm.addEventListener('submit', async (e)=>{
    e.preventDefault(); clearAlert();

    let errors = [];
    if (!cur.value) errors.push('Vui lòng nhập mật khẩu hiện tại');
    if (!n1.value || n1.value.length < 6) errors.push('Mật khẩu mới tối thiểu 6 ký tự');
    if (n1.value !== n2.value) errors.push('Xác nhận mật khẩu chưa khớp');

    if (errors.length){
      frm.classList.add('was-validated');
      showAlert('Không thể đổi mật khẩu: ' + errors.join(' · '), 'danger');
      return;
    }

    busy(true);
    try{
      await fetchWithAuth(ENDPOINT, {
        method:'POST',
        body: { currentPassword: cur.value, newPassword: n1.value }
      });
      showAlert('✅ Đổi mật khẩu thành công.', 'success');
      frm.reset(); frm.classList.remove('was-validated');
    }catch(err){
      if (err?.code === 'WRONG_CURRENT_PASSWORD' || /hiện tại\s*không\s*đúng/i.test(err?.message||'')) {
        cur.classList.add('is-invalid');
        cur.value = '';
        n1.value = ''; n2.value = '';
        cur.focus();
        showAlert(err.message || 'Mật khẩu hiện tại không đúng. Vui lòng thử lại.', 'danger');
        return;
      }
      showAlert(err?.message || 'Đổi mật khẩu thất bại', 'danger');
    }finally{
      busy(false);
    }
  });
})();
</script>
</body>
</html>
