<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>T·∫°o phi·∫øu tr·∫£ h√†ng cho NCC - Warehouse</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="css/style.css" rel="stylesheet">
  <style>
    .table-secondary.text-muted td {
      opacity: 0.6;
    }
  </style>
</head>

<body class="bg-light d-flex">
  <!-- Sidebar -->
  <div id="sidebar" class="flex-shrink-0"></div>

  <!-- Main content -->
  <main class="flex-grow-1 container py-4">
    <h3 class="mb-3">üîÅ Tr·∫£ h√†ng cho Nh√† cung c·∫•p</h3>

    <div class="card p-3 mb-3 shadow-sm">
      <div><strong>M√£ bi√™n lai:</strong> <span id="receiptIdText"></span></div>
      <div><strong>Nh√† cung c·∫•p:</strong> <span id="supplierIdText"></span></div>
      <div><strong>Ng∆∞·ªùi x·ª≠ l√Ω:</strong> <span id="userIdText"></span></div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>M√£ h√†ng</th>
            <th>T√™n h√†ng</th>
            <th>T√™n l√¥</th>
            <th>S·ªë l∆∞·ª£ng ƒë·∫∑t</th>
            <th>S·ªë l∆∞·ª£ng trong kho</th>
            <th>S·ªë l∆∞·ª£ng tr·∫£</th>
            <th>L√Ω do tr·∫£ h√†ng</th>
          </tr>
        </thead>
        <tbody id="tblReturn"></tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button class="btn btn-secondary" onclick="goBack()">
        <i class="bi bi-arrow-left me-1"></i> Quay l·∫°i
      </button>
      <button class="btn btn-danger" onclick="confirmReturn()">
        <i class="bi bi-check-circle me-1"></i> X√°c nh·∫≠n tr·∫£ h√†ng
      </button>
    </div>

    <p id="msg" class="text-muted mt-3"></p>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
const API_BASE = "https://localhost:7225/api";
const token = localStorage.getItem("accessToken") || sessionStorage.getItem("accessToken");

if (!token) {
  alert("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
  window.location.href = "login.html";
}

const userId = parseInt(localStorage.getItem("userId") || sessionStorage.getItem("userId"));
const params = new URLSearchParams(location.search);
const receiptId = parseInt(params.get("receiptId"));
const supplierId = parseInt(params.get("supplierId"));

document.getElementById("receiptIdText").textContent = receiptId;

function authHeaders() {
  return { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
}

// üß© Hi·ªÉn th·ªã t√™n Supplier v√† User
async function loadSupplierName() {
  try {
    const res = await fetch(`https://localhost:7225/api/Suppliers/${supplierId}?max=100`, { headers: authHeaders() });
    if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y nh√† cung c·∫•p");
    const data = await res.json();
    document.getElementById("supplierIdText").textContent = data.name || `#${supplierId}`;
  } catch (e) {
    console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i t√™n Supplier:", e.message);
    document.getElementById("supplierIdText").textContent = `#${supplierId}`;
  }
}

async function loadUserName() {
  try {
    const res = await fetch(`https://localhost:7225/api/Auth/user/${userId}`, { headers: authHeaders() });
    if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng");
    const data = await res.json();
    document.getElementById("userIdText").textContent = data.name || data.username || `#${userId}`;
  } catch (e) {
    console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i t√™n User:", e.message);
    document.getElementById("userIdText").textContent = `#${userId}`;
  }
}

loadSupplierName();
loadUserName();

function setMsg(text, type = "text-muted") {
  const el = document.getElementById("msg");
  if (!el) return;
  el.className = type;
  el.textContent = text || "";
}

function goBack() {
  window.location.href = "warehouse_receipts.html";
}

// === 1Ô∏è‚É£ Load danh s√°ch h√†ng t·ª´ API preview ===
async function loadReturnPreview() {
  try {
    setMsg("ƒêang t·∫£i d·ªØ li·ªáu...", "text-muted");
    const res = await fetch(`${API_BASE}/ReturnOrders/preview-confirm/${receiptId}`, { headers: authHeaders() });
    if (!res.ok) {
      const err = await res.text();
      throw new Error(`${res.status}: ${err}`);
    }
    const data = await res.json();
    const tbody = document.getElementById("tblReturn");
    tbody.innerHTML = "";

    if (!data.previewItems || data.previewItems.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
      setMsg("Kh√¥ng c√≥ h√†ng h√≥a n√†o ƒë·ªÉ tr·∫£.", "text-warning");
      return;
    }

    data.previewItems.forEach((item) => {
      const disabled = Number(item.quantityToReturn) <= 0;
      const noteCell = disabled
        ? `<input type="text" class="form-control form-control-sm reason" placeholder="ƒê√£ ƒë·ªß h√†ng" disabled>`
        : `<input type="text" class="form-control form-control-sm reason" placeholder="Nh·∫≠p l√Ω do">`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.goodID}</td>
        <td>${item.goodName}</td>
        <td>${item.batchNo ?? ""}</td>
        <td class="text-end">${item.quantityOrdered}</td>
        <td class="text-end">${item.quantityReceived}</td>
        <td class="text-end">${item.quantityToReturn}</td>
        <td>${noteCell}</td>
      `;
      if (disabled) tr.classList.add("table-secondary", "text-muted");
      tbody.appendChild(tr);
    });

    setMsg("‚úÖ ƒê√£ t·∫£i danh s√°ch h√†ng tr·∫£.", "text-success");
  } catch (e) {
    console.error(e);
    setMsg(`‚ùå L·ªói t·∫£i danh s√°ch h√†ng tr·∫£: ${e.message}`, "text-danger");
  }
}

// === 2Ô∏è‚É£ Khi ng∆∞·ªùi d√πng ·∫•n "X√°c nh·∫≠n tr·∫£ h√†ng" ‚Üí t·∫°o phi·∫øu ===
async function confirmReturn() {
  if (!confirm("X√°c nh·∫≠n t·∫°o phi·∫øu tr·∫£ h√†ng g·ª≠i nh√† cung c·∫•p?")) return;

  const rows = document.querySelectorAll("#tblReturn tr");
  const items = [];

  rows.forEach((tr) => {
    const tds = tr.querySelectorAll("td");
    if (tds.length < 6) return;
    const goodId = parseInt(tds[0].textContent);
    const qtyToReturn = Number(tds[5].textContent);
    const reason = tr.querySelector(".reason")?.value.trim() || "";
    if (qtyToReturn > 0) {
      items.push({ goodID: goodId, quantityToReturn: qtyToReturn, reason, unitCost: 0, batchID: null });
    }
  });

  if (items.length === 0) {
    alert("‚ùå Kh√¥ng c√≥ m·∫∑t h√†ng n√†o c·∫ßn tr·∫£.");
    return;
  }

  const body = { receiptId, supplierId, userId, note: "Phi·∫øu tr·∫£ h√†ng t·ª´ Kho", items };

  try {
    setMsg("ƒêang x·ª≠ l√Ω...", "text-muted");
    const res = await fetch(`${API_BASE}/ReturnOrders`, {
      method: "POST",
      headers: authHeaders(),
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || JSON.stringify(data));
    alert("‚úÖ " + (data.message || "ƒê√£ t·∫°o phi·∫øu tr·∫£ h√†ng th√†nh c√¥ng!"));
    setMsg("ƒê√£ t·∫°o phi·∫øu tr·∫£ h√†ng #" + data.returnId, "text-success");
    setTimeout(() => goBack(), 1000);
  } catch (e) {
    console.error(e);
    alert("‚ùå L·ªói t·∫°o phi·∫øu tr·∫£ h√†ng: " + e.message);
    setMsg("‚ùå L·ªói t·∫°o phi·∫øu tr·∫£ h√†ng: " + e.message, "text-danger");
  }
}

// ==== Sidebar ====
fetch("sidebar.html")
  .then(res => res.text())
  .then(html => { document.getElementById("sidebar").innerHTML = html; })
  .catch(err => console.error("L·ªói t·∫£i sidebar:", err));

// === Load khi trang ƒë∆∞·ª£c t·∫£i ===
window.addEventListener("DOMContentLoaded", loadReturnPreview);
</script>

</body>
</html>
