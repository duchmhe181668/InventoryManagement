<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thông tin người dùng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root{
      --primary-start:#2f80ed; --primary-end:#1c64f2;
      --border:#e5e7eb; --muted:#6b7280; --field:#f3f6ff;
      --radius-card:26px; --radius-btn:14px; --radius-pill:20px;
      --shadow-card:0 26px 70px rgba(28,100,242,.12), 0 10px 24px rgba(16,24,40,.08);
    }
    body{
      min-height:100vh; background:radial-gradient(1400px 700px at 15% 15%, #eef4ff 0%, #f7f9fc 40%, #f5f7fb 100%);
      display:flex; align-items:center; justify-content:center; padding:28px;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans";
      color:#0f172a;
    }
    .card-profile{
      width:100%; max-width:800px; border:none; border-radius:var(--radius-card);
      box-shadow:var(--shadow-card); background:#fff; padding:28px 26px;
    }
    .page-title{ font-weight:800; color:#111827; }
    .page-sub{ color:var(--muted); }
    .btn-light{ border-radius:12px; }

    /* pill input group */
    .input-group.pill{
      border:1px solid var(--border); border-radius:var(--radius-pill);
      overflow:hidden; background:var(--field);
    }
    .input-group.pill:focus-within{ border-color:#86b7fe; box-shadow:0 0 0 .2rem rgba(13,110,253,.12); background:#fff; }
    .input-group.pill > .input-group-text,
    .input-group.pill > .form-control{ border:0 !important; border-radius:0 !important; background:transparent; }
    .input-group.pill > .input-group-text{ padding:.72rem .9rem; color:#334155; }
    .input-group.pill > .form-control{ padding:.84rem .95rem; }

    .form-label{ margin-bottom:.4rem; font-weight:600; }
    .form-text{ color:#64748b; }

    .btn-primary{
      border:none; border-radius:var(--radius-btn); padding:.9rem 1rem; font-weight:700;
      background-image:linear-gradient(180deg,var(--primary-start),var(--primary-end));
      box-shadow:0 10px 24px rgba(28,100,242,.24), 0 4px 10px rgba(28,100,242,.18);
    }
    .btn-primary:hover{ filter:brightness(.98); background-image:linear-gradient(180deg,var(--primary-end),var(--primary-end)); }

    .divider{ height:1px; background:#edf1f7; margin:14px 0 6px; }
  </style>
</head>
<body>
  <div class="card-profile">
    <!-- header -->
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div>
        <div class="page-title h4 mb-1"><i class="bi bi-person-gear me-2 text-primary"></i>Thông tin của bạn</div>
        <div class="page-sub">Xem và cập nhật thông tin tài khoản cá nhân</div>
      </div>
      <a href="home.html" class="btn btn-light"><i class="bi bi-arrow-left me-1"></i> Về trang chủ</a>
    </div>
    <div id="alert" class="alert d-none" role="alert"></div>

    <!-- info form -->
    <form id="profileForm" novalidate>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Tên đăng nhập</label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
            <input id="Username" class="form-control" readonly>
          </div>
          <div class="form-text">Không thể đổi tên đăng nhập.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Vai trò</label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-shield-lock-fill"></i></span>
            <input id="RoleName" class="form-control" readonly>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Họ tên <span class="text-danger">*</span></label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-person-badge-fill"></i></span>
            <input id="Name" class="form-control" required placeholder="Tên hiển thị">
          </div>
          <div class="invalid-feedback">Vui lòng nhập họ tên.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Email</label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
            <input id="Email" type="email" class="form-control" placeholder="you@example.com">
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Số điện thoại</label>
          <div class="input-group pill">
            <span class="input-group-text"><i class="bi bi-telephone-fill"></i></span>
            <input id="PhoneNumber" class="form-control" placeholder="090xxxxxxx">
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="d-flex gap-2 mt-3">
        <button id="btnSave" class="btn btn-primary" type="submit">
          <span id="spnLoad" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          <i class="bi bi-save2 me-1"></i> Lưu thay đổi
        </button>
        <button type="button" id="btnReset" class="btn btn-light"><i class="bi bi-arrow-clockwise me-1"></i> Hoàn tác</button>
      </div>
    </form>
  </div>

<script>
(function(){
  // ==== Config API (đổi nếu cần) ====
  const API_BASE = 'https://localhost:7225/api/Auth';
  const URL = {
    me:      () => `${API_BASE}/me`,
    profile: () => `${API_BASE}/profile`   // GET/PUT chính chủ
  };

  // ==== DOM ====
  const f = {
    Username: document.getElementById('Username'),
    RoleName: document.getElementById('RoleName'),
    Name: document.getElementById('Name'),
    Email: document.getElementById('Email'),
    PhoneNumber: document.getElementById('PhoneNumber'),
  };
  const form = document.getElementById('profileForm');
  const alertBox = document.getElementById('alert');
  const btnSave = document.getElementById('btnSave');
  const btnReset = document.getElementById('btnReset');
  const spnLoad = document.getElementById('spnLoad');

  // ==== UI helpers ====
  function showAlert(msg,type='danger',sticky=true){
    alertBox.textContent = msg;
    alertBox.className = `alert alert-${type}`;
    alertBox.classList.remove('d-none');
    if(!sticky) setTimeout(()=>alertBox.classList.add('d-none'),3000);
  }
  function clearAlert(){ alertBox.className='alert d-none'; alertBox.textContent=''; }
  function setBusy(b){ btnSave.disabled=b; spnLoad.classList.toggle('d-none',!b); }

  // ==== Auth helpers ====
  function preferLocal(){ // ưu tiên nhớ đăng nhập
    return (localStorage.getItem('accessToken') || localStorage.getItem('authToken')) ? localStorage : sessionStorage;
  }
  function getToken(){
    const store = preferLocal();
    const token = store.getItem('accessToken') || store.getItem('authToken') || '';
    const type  = store.getItem('tokenType') || 'Bearer';
    return {token,type,store,has:!!token};
  }
  function parseExpireAt(raw){
    if(!raw) return null;
    let n = Number(raw);
    if(!Number.isFinite(n)){ const t = Date.parse(raw); if(Number.isFinite(t)) n=t; }
    if(!Number.isFinite(n)) return null;
    if(n < 1e12) n*=1000; // giây -> ms
    return n;
  }
  function getJwtExpMs(token){
    try{
      const p = token.split('.');
      if(p.length<2) return null;
      const payload = JSON.parse(atob(p[1].replace(/-/g,'+').replace(/_/g,'/')));
      if(typeof payload.exp!=='number') return null;
      return payload.exp*1000;
    }catch{ return null; }
  }
  function checkTokenExpiry(){
    const {token,store} = getToken();
    let exp = parseExpireAt(store.getItem('tokenExpireAt'));
    if(!exp && token) exp = getJwtExpMs(token);
    if(!exp) return true; // không biết -> cho đi tiếp rồi server chặn
    return Date.now() <= (exp + 5000);
  }
  function ensureAuthOrRedirect(){
    const {has} = getToken();
    const valid = checkTokenExpiry();
    if(!has || !valid){
      showAlert('Phiên đăng nhập đã hết hạn hoặc thiếu token. Vui lòng đăng nhập lại.','warning');
      setTimeout(()=>window.location.href='login.html',8000);
      return false;
    }
    return true;
  }
  function buildHeaders(extra = {}){
    const {token,type} = getToken();
    if(!token) throw new Error('Thiếu token');
    return Object.assign(
      {'Accept':'application/json', 'Authorization':`${type} ${token}`},
      extra || {}
    );
  }

  // ==== fetch helper: sửa triệt để lỗi 415 ====
  async function fetchWithAuth(url, opt = {}) {
    const opts = { method:'GET', ...opt };
    const headers = buildHeaders(opts.headers);

    const hasBody = Object.prototype.hasOwnProperty.call(opts, 'body') && opts.body != null;
    if (hasBody) {
      if (typeof opts.body !== 'string') {
        opts.body = JSON.stringify(opts.body);       // stringify nếu là object
      }
      if (!headers['Content-Type'] && !headers['content-type']) {
        headers['Content-Type'] = 'application/json'; // đảm bảo header
      }
    }
    opts.headers = headers;

    const res = await fetch(url, opts);
    if (res.status === 401) {
      showAlert('401 Unauthorized. Đang chuyển về đăng nhập…', 'warning');
      setTimeout(()=>window.location.href='login.html',800);
      throw new Error('401');
    }

    const text = await res.text().catch(()=> '');
    let data; try{ data = text ? JSON.parse(text) : null; }catch{ data = text; }

    if (res.status === 403) { showAlert('Bạn không có quyền thao tác này.', 'warning'); throw new Error('403'); }
    if (!res.ok) {
      const msg = (data && (data.title || data.message)) || (typeof data === 'string' ? data : `HTTP ${res.status}`);
      throw new Error(msg);
    }
    return data;
  }

  // ==== Load & Fill ====
  let original = null;

  async function loadProfile(){
    if(!ensureAuthOrRedirect()) return;
    try{
      // Lấy tên/claims nhanh (tùy server)
      const me = await fetchWithAuth(URL.me(), {method:'GET'}).catch(()=>null);
      const nameFromToken = me?.User || '';

      // Lấy hồ sơ chi tiết
      const p = await fetchWithAuth(URL.profile(), {method:'GET'});
      original = p || {};

      f.Username.value    = p?.username ?? nameFromToken ?? '';
      f.RoleName.value    = p?.roleName ?? p?.role ?? '';
      f.Name.value        = p?.name ?? '';
      f.Email.value       = p?.email ?? '';
      f.PhoneNumber.value = p?.phoneNumber ?? p?.phone ?? '';
    }catch(err){
      showAlert('Không tải được thông tin: ' + (err?.message || err), 'danger');
    }
  }

  function resetForm(){
    if(!original) return;
    f.Name.value        = original.name ?? '';
    f.Email.value       = original.email ?? '';
    f.PhoneNumber.value = original.phoneNumber ?? original.phone ?? '';
  }

  // ==== Submit ====
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!ensureAuthOrRedirect()) return;

    if(!form.checkValidity()){
      form.classList.add('was-validated');
      return;
    }

    const payload = {
      Name: (f.Name.value||'').trim(),
      Email: (f.Email.value||'').trim() || null,
      PhoneNumber: (f.PhoneNumber.value||'').trim() || null
    };

    setBusy(true);
    clearAlert();
    try{
      // body là object -> fetchWithAuth tự stringify + set Content-Type
      await fetchWithAuth(URL.profile(), { method:'PUT', body: payload });
      showAlert('Đã cập nhật thông tin của bạn.', 'success', false);
      original = { ...original, ...payload };
    }catch(err){
      showAlert('Cập nhật thất bại: ' + (err?.message || err), 'danger');
      console.error(err);
    }finally{
      setBusy(false);
    }
  });

  btnReset.addEventListener('click', resetForm);

  // init
  loadProfile();
})();
</script>
</body>
</html>
